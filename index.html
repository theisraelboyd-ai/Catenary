<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Catenary Grapher</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --brand:#004080; --ink:#222; --muted:#606770; --bg:#f6f8fb;
      --panel:#fff; --line:#d4dae3; --hdr:#eef2f6; --row:#fbfdff; --band:#fff59d;
      --pagew:1080px; --colw-depth:120px; --colw-num:120px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
    .page{width:var(--pagew); margin:0 0 18px 16px;}
    header{background:var(--brand);color:#fff;padding:10px 14px;margin-left:-16px;width:calc(var(--pagew) + 32px);}
    header h2{margin:0;font-size:20px}

    .controls{
      background:var(--panel);border:1px solid var(--line);border-radius:6px;padding:12px;margin-top:12px;
      display:grid; grid-template-columns: 420px 1fr; gap:14px;
    }
    .leftStack{display:flex;flex-direction:column;gap:12px}
    .section{background:#fff; border:1px dashed var(--line); border-radius:6px; padding:10px}
    .section > h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:bold}
    .flip{display:flex;gap:8px;align-items:center}
    .flip input,.flip select{order:1; width:160px; font-size:13px; padding:4px 6px}
    .flip span{order:2; font-size:13px; color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:8px}
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:4px;padding:6px 12px;font-size:13px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-lite{background:#9097a1;color:#fff}
    .btn-lite:hover{filter:brightness(1.05)}
    .tiny{padding:2px 6px;font-size:12px}
    .tensionSelect{width:160px;font-size:13px;padding:4px 6px}

    /* Right panel (info + chart + controls) */
    #infoPanel{display:flex;flex-direction:column;min-height:320px}
    #infoPanel h4{margin:0 0 6px 0;font-size:14px}
    #infoPanel p{margin:6px 0 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    #formulaImg{max-width:100%;height:auto;border:1px solid var(--line);border-radius:6px;margin-bottom:8px;display:block}
    #inlineChartWrap{border:1px solid var(--line);border-radius:6px;padding:6px;margin-top:10px}
    #noChartMsg{font-size:12px;color:var(--muted);text-align:center;padding:8px 0}
    #inlineChart{display:none;width:100%;height:300px}
    .chartCtrls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px}
    .chartCtrls label{font-size:12px;color:var(--muted)}
    .chartCtrls input[type=number]{width:90px;padding:4px 6px;font-size:12px}
    .chartCtrls .wide{width:110px}

    /* Workspace */
    .workspace{display:grid;grid-template-columns:1fr 260px;gap:10px;margin-top:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:6px}
    #tableWrapper{overflow:auto;max-height:66vh}

    /* Table */
    table{border-collapse:collapse;width:100%;background:#fff;font-size:12px;line-height:1.35}
    col.depth{width:var(--colw-depth)}
    col.num{width:var(--colw-num)}
    th,td{border:1px solid #cfd6df; padding:4px 8px; text-align:center; font-variant-numeric:tabular-nums; vertical-align:middle; white-space:nowrap;}
    thead th{background:var(--hdr);position:sticky;top:0;z-index:2}
    thead .meta th{font-weight:700;font-size:12.5px;text-align:center;background:#e7eef7}
    tbody tr:nth-child(even) td{background:var(--row)}
    tbody tr.band td{background:var(--band)!important}
    tbody tr.cursor td{outline:2px solid #f1c40f; outline-offset:-2px}
    
    /* Row Highlighter — polished look */
#hiPanel{
  padding:12px;border-radius:8px;border:1px solid var(--line);
  background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.03);
}
#hiPanel h4{font-weight:600}
#hiPanel .hiRow label{color:var(--ink);font-weight:600}
#hiPanel input[type=range]{accent-color:var(--brand);height:4px}
#hiStartLbl,#hiEndLbl{
  background:#e7eef7;border-radius:999px;padding:2px 8px;
  min-width:28px;text-align:center;font-variant-numeric:tabular-nums
}
#hiReadout{background:#f8fbff;border:1px dashed var(--line);padding:6px;border-radius:6px}
.hiBtns .btn-lite{background:#6b7280;color:#fff}

    /* Print-only header row that repeats on each page */
    .print-only { display: none; }
    @media print {
      thead .print-only { display: table-row !important; }
      header{display:none}
      .controls{display:none}
      #rightStack{display:none}
      .page{width:auto;margin:0}
      .workspace{display:block !important; grid-template-columns:1fr !important; gap:0 !important}
      #tableWrapper{max-height:none;overflow:visible;width:100%}
      #tableArea table{width:100% !important}
      col.depth, col.num { width:auto !important }
      th,td{padding:3px 6px}
    }
  </style>
</head>
<body>
  <div class="page">
    <header><h2>Catenary Grapher</h2></header>

    <div class="controls">
      <div class="leftStack">
        <div class="section">
          <h4>Inputs</h4>
          <div class="stack">
            <label class="flip"><input type="number" id="weightWater" value="50" step="0.01" min="0.01"><span>Weight in water (kg/m)</span></label>
            <label class="flip"><input type="number" id="weightAir" value="60" step="0.01" min="0"><span>Weight in air (kg/m)</span></label>
            <label class="flip"><input type="number" id="sheaveHeight" value="2" step="0.01" min="0"><span>Sheave height (m)</span></label>
            <label class="flip"><input type="number" id="maxDepth" value="100" step="0.1" min="0.1"><span>Max depth (m)</span></label>
            <label class="flip"><input type="number" id="step" value="10" step="0.1" min="0.1"><span>Depth step (m)</span></label>
          </div>
        </div>

        <div class="section">
          <h4>Bottom tensions</h4>
          <div class="stack">
            <div class="inline">
              <label class="flip">
                <select id="tensionBase" class="tensionSelect">
                  <option value="250" selected>250 kg</option>
                  <option value="300">300 kg</option><option value="350">350 kg</option>
                  <option value="400">400 kg</option><option value="450">450 kg</option>
                  <option value="500">500 kg</option><option value="550">550 kg</option>
                  <option value="600">600 kg</option><option value="650">650 kg</option>
                  <option value="700">700 kg</option><option value="750">750 kg</option>
                  <option value="800">800 kg</option><option value="850">850 kg</option>
                  <option value="900">900 kg</option><option value="950">950 kg</option>
                  <option value="1000">1000 kg</option><option value="1050">1050 kg</option>
                  <option value="1100">1100 kg</option><option value="1150">1150 kg</option>
                  <option value="1200">1200 kg</option><option value="1250">1250 kg</option>
                  <option value="1300">1300 kg</option><option value="1350">1350 kg</option>
                  <option value="1400">1400 kg</option><option value="1450">1450 kg</option>
                  <option value="1500">1500 kg</option><option value="1550">1550 kg</option>
                  <option value="1600">1600 kg</option><option value="1650">1650 kg</option>
                  <option value="1700">1700 kg</option><option value="1750">1750 kg</option>
                  <option value="1800">1800 kg</option><option value="1850">1850 kg</option>
                  <option value="1900">1900 kg</option><option value="1950">1950 kg</option>
                  <option value="2000">2000 kg</option><option value="2050">2050 kg</option>
                  <option value="2100">2100 kg</option><option value="2150">2150 kg</option>
                  <option value="2200">2200 kg</option><option value="2250">2250 kg</option>
                  <option value="2300">2300 kg</option><option value="2350">2350 kg</option>
                  <option value="2400">2400 kg</option><option value="2450">2450 kg</option>
                  <option value="2500">2500 kg</option>
                </select>
                <span><strong>Primary bottom tension</strong></span>
              </label>
            </div>
            <div id="extraTensions" class="stack"></div>
            <div><button type="button" class="btn tiny" id="addBtn">+ Add Tension</button></div>
          </div>
        </div>

        <div class="section">
          <h4>Mode</h4>
          <div class="stack">
            <label class="flip"><input type="radio" name="mode" value="detail" style="width:auto"><span>Detail (all parameters) — <em>primary tension only</em></span></label>
            <label class="flip"><input type="radio" name="mode" value="compare" checked style="width:auto"><span>Compare Bottom Tensions</span></label>
          </div>
        </div>

        <div class="section">
          <h4>Parameter (compare mode)</h4>
          <div class="stack">
            <label class="flip"><input type="radio" name="display" value="layback" checked style="width:auto"><span>Layback</span></label>
            <label class="flip"><input type="radio" name="display" value="length" style="width:auto"><span>Cable length</span></label>
            <label class="flip"><input type="radio" name="display" value="angle" style="width:auto"><span>Angle (° from vertical)</span></label>
            <label class="flip"><input type="radio" name="display" value="topTension" style="width:auto"><span>Top tension</span></label>
          </div>
          <div class="inline" style="margin-top:6px">
            <button class="btn" id="genBtn">Generate Table</button>
            <button class="btn" id="chartBtn">Pop-out Chart</button>
            <button class="btn" onclick="window.print()">Print Table</button>
          </div>
        </div>
      </div>

      <div id="infoPanel" class="section">
        <div class="inline" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <h4 style="margin:0">Formula walkthrough (kg-based)</h4>
        </div>
      <img id="formulaImg" src="assets/catenary-formulas.png" alt="Catenary formula sheet"/>
        <div id="inlineChartWrap">
          <div id="noChartMsg">No chart yet — click <strong>Generate Table</strong> first.</div>
          <canvas id="inlineChart"></canvas>

          <!-- Chart controls -->
          <div class="chartCtrls">
            <label>Depth from</label><input type="number" id="xMin" class="wide" step="0.1">
            <label>to</label><input type="number" id="xMax" class="wide" step="0.1">
            <label>Y min</label><input type="number" id="yMin" step="0.1">
            <label>Y max</label><input type="number" id="yMax" step="0.1">
            <label>Y step</label><input type="number" id="yStep" step="0.1">
            <label class="inline" style="gap:4px"><input type="checkbox" id="minorGrid" style="width:auto"> minor grid (½-step)</label>
            <button class="btn tiny" id="applyChart">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <div class="workspace">
      <div id="tableWrapper" class="panel">
        <div id="tableArea"></div>
      </div>

      <div id="rightStack">
        <aside id="hiPanel" class="panel">
          <h4>Row Highlighter</h4>
          <div class="hiRow" style="margin-bottom:6px">
            <label class="flip" style="gap:6px">
              <input type="checkbox" id="hiEnable" style="width:auto">
              <span>Enable highlighter</span>
            </label>
          </div>
          <p id="hiHint" class="muted">Turn on to use sliders or click-drag on the table.</p>
          <div class="hiGroup">
            <div class="hiRow">
              <label style="width:64px">Start</label>
              <input type="range" id="hiStart" min="1" max="1" value="1" disabled>
              <span id="hiStartLbl" class="muted" style="width:28px;text-align:right">1</span>
            </div>
          </div>
          <div class="hiGroup">
            <div class="hiRow">
              <label style="width:64px">End</label>
              <input type="range" id="hiEnd" min="1" max="1" value="1" disabled>
              <span id="hiEndLbl" class="muted" style="width:28px;text-align:right">1</span>
            </div>
          </div>
          <div id="hiReadout" class="muted">Depths: –</div>
          <div class="hiBtns">
            <button class="btn-lite tiny" id="hiUp" disabled>▲ Up</button>
            <button class="btn-lite tiny" id="hiDown" disabled>▼ Down</button>
            <button class="btn-lite tiny" id="hiClear" disabled>Clear</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Polyfills ---------- */
    const ACOSH = Math.acosh || function(x){ return Math.log(x + Math.sqrt((x-1)*(x+1))); };
    const SINH  = Math.sinh  || function(x){ const e=Math.exp(x), ei=1/e; return (e-ei)/2; };

    /* ---------- Minor grid plugin ---------- */
    const minorGridPlugin = {
      id: 'minorGrid',
      afterDraw(chart, args, opts){
        if(!opts || !opts.enabled) return;
        const { xStep, yStep } = opts;
        const x = chart.scales.x, y = chart.scales.y;
        const ctx = chart.ctx; ctx.save();
        ctx.strokeStyle = 'rgba(0,0,0,0.07)'; ctx.lineWidth = 0.5;

        if(Number.isFinite(xStep) && x && x.min != null && x.max != null){
          const dx = xStep/2;
          for(let v = x.min + dx; v < x.max - 1e-9; v += xStep){
            const px = x.getPixelForValue(v); ctx.beginPath();
            ctx.moveTo(px, y.top); ctx.lineTo(px, y.bottom); ctx.stroke();
          }
        }
        if(Number.isFinite(yStep) && y && y.min != null && y.max != null){
          const dy = yStep/2;
          for(let v = y.min + dy; v < y.max - 1e-9; v += yStep){
            const py = y.getPixelForValue(v); ctx.beginPath();
            ctx.moveTo(x.left, py); ctx.lineTo(x.right, py); ctx.stroke();
          }
        }
        ctx.restore();
      }
    };
    Chart.register(minorGridPlugin);

    /* ---------- Helpers ---------- */
    function buildDepths(maxDepth, step) {
      const M = +maxDepth, S = +step;
      if (!isFinite(M) || !isFinite(S) || M <= 0 || S <= 0) throw new Error('Max depth and step must be positive.');
      const out = [];
      if (S >= M) { out.push(+M.toFixed(6)); return out; }
      let d = S, count = 0; const CAP = 5000;
      while (d <= M + 1e-9 && count < CAP) { out.push(+d.toFixed(6)); d += S; count++; }
      if (out.length === 0) out.push(+M.toFixed(6));
      return out;
    }
    const qs = s => document.querySelector(s);

    /* ---------- UI wiring ---------- */
    document.getElementById('addBtn').addEventListener('click', () => {
      const container = document.getElementById('extraTensions');
      const row = document.createElement('div'); row.className = 'inline';
      const sel = document.createElement('select');
      sel.className = 'tensionSelect';
      sel.innerHTML = document.getElementById('tensionBase').innerHTML;
      sel.value = '500';
      const rm = document.createElement('button');
      rm.type = 'button'; rm.className = 'btn-lite tiny'; rm.textContent = 'Remove';
      rm.onclick = () => row.remove();
      row.appendChild(sel); row.appendChild(rm);
      container.appendChild(row);
    });

    document.getElementById('genBtn').addEventListener('click', calculate);
    document.getElementById('chartBtn').addEventListener('click', openChartWindow);
    document.getElementById('applyChart').addEventListener('click', ()=> renderInlineChart(true));

    function collectTensions(){
      const base = parseFloat(document.getElementById('tensionBase').value);
      const extras = [...document.querySelectorAll('#extraTensions .tensionSelect')].map(s => parseFloat(s.value));
      return [base, ...extras].filter((v,i,a)=>a.indexOf(v)===i);
    }

    function buildTableHTML(mode, tensions, results, depths, display, printMeta){
      let colgroup = `<colgroup><col class="depth">`;
      const numCols = (mode==='compare') ? tensions.length : 4;
      for(let i=0;i<numCols;i++) colgroup += `<col class="num">`;
      colgroup += `</colgroup>`;

      const tensionsLabel = (mode==='compare' ? tensions.map(t=>`${t}kg`).join(', ') : `${tensions[0]}kg (primary)`);
      const paramLabel = (mode==='compare' ? (display==='angle' ? 'angle (° from vertical)' : display) : 'Detail (primary)');
      const colspan = (mode==='compare') ? tensions.length + 1 : 5;

      const metaRow = `<tr class="meta"><th colspan="${colspan}">
        Bottom tensions: ${tensionsLabel}  |  Parameter: ${paramLabel}
      </th></tr>`;

      const printRow = (printMeta)
        ? `<tr class="print-only"><th colspan="${colspan}">
             Inputs — weight in water: ${printMeta.water} kg/m · weight in air: ${printMeta.air} kg/m · sheave height: ${printMeta.sheave} m
           </th></tr>`
        : '';

      let headRow='';
      if(mode==='compare'){
        headRow = `<tr><th>Depth (m)</th>${tensions.map(t=>`<th>${t}kg</th>`).join('')}</tr>`;
      }else{
        headRow = `<tr><th>Depth</th><th>Layback</th><th>Length</th><th>Angle (° from vertical)</th><th>Top Tension</th></tr>`;
      }

      let tbody='<tbody>';
      if(mode==='compare'){
        depths.forEach((depth,i)=>{
          tbody += `<tr data-row="${i+1}">
            <td>${depth.toFixed(2)}</td>${tensions.map(t=>`<td>${results[t][i][display].toFixed(2)}</td>`).join('')}
          </tr>`;
        });
      }else{
        const t = tensions[0];
        depths.forEach((depth,i)=>{
          const r = results[t][i];
          tbody += `<tr data-row="${i+1}">
            <td>${r.depth.toFixed(2)}</td><td>${r.layback.toFixed(2)}</td><td>${r.length.toFixed(2)}</td>
            <td>${r.angle.toFixed(2)}</td><td>${r.topTension.toFixed(2)}</td>
          </tr>`;
        });
      }
      tbody+='</tbody>';

      return `<table id="resultTable">${colgroup}<thead>${metaRow}${printRow}${headRow}</thead>${tbody}</table>`;
    }

    function calculate(){
      const weightWater = +qs('#weightWater').value;
      const weightAir   = +qs('#weightAir').value;
      const sheave      = +qs('#sheaveHeight').value;
      const maxDepth    = +qs('#maxDepth').value;
      const step        = +qs('#step').value;
      const mode        = qs('input[name="mode"]:checked').value;
      const display     = qs('input[name="display"]:checked').value;

      const tensions = collectTensions();
      if (!tensions.length) { alert('Please set at least one bottom tension.'); return; }

      let depths;
      try { depths = buildDepths(maxDepth, step); }
      catch(err){ alert(err.message); return; }

      const results = {};
      const PI = Math.PI;
      tensions.forEach(bt=>{
        const a = bt / weightWater;
        results[bt] = depths.map(depth=>{
          const x = a * ACOSH(depth / a + 1);
          const X1 = SINH(x / a);
          const angleHoriz = Math.atan(X1) * 180 / PI;
          const angleFromVertical = 90 - angleHoriz;
          const s = a * X1;
          const topTension = bt + weightWater * s + weightAir * sheave;
          return { depth, layback: x, length: s, angle: angleFromVertical, topTension };
        });
      });

      document.getElementById('tableArea').innerHTML =
        buildTableHTML(mode, tensions, results, depths, display,
          { water: weightWater, air: weightAir, sheave: sheave });

      hookRowSelection(); initRangeHighlighter(depths);
      if (document.getElementById('hiEnable').checked) setRange(1,1,true);

      // Default chart options
      const dMin = depths[0], dMax = depths[depths.length-1];
      qs('#xMin').value = dMin; qs('#xMax').value = dMax;
      qs('#yMin').value = ''; qs('#yMax').value = ''; qs('#yStep').value = ''; qs('#minorGrid').checked = false;

      window.chartData = { tensions, depths, results, mode, display, xStepInput: step, weights: { water: weightWater, air: weightAir, sheave } };
      renderInlineChart(true);
    }

    /* ---------- Inline chart (linear x + controls) ---------- */
    let inlineChart = null;
    function toPoints(depths, arr){
      const pts = [];
      for(let i=0;i<depths.length;i++){
        const y = Number(arr[i]); const x = Number(depths[i]);
        pts.push(Number.isFinite(x) && Number.isFinite(y) ? {x, y} : {x, y:null});
      }
      return pts;
    }
    function minMaxFromDatasets(datasets){
      const nums = [];
      datasets.forEach(ds => ds.data.forEach(p => { if (p && Number.isFinite(p.y)) nums.push(p.y); }));
      if (!nums.length) return null;
      let min = Math.min(...nums), max = Math.max(...nums);
      if (min === max) { const pad = Math.abs(min) * 0.05 || 1; min -= pad; max += pad; }
      const span = max - min, pad = span * 0.05;
      return {min: min - pad, max: max + pad};
    }
    function renderInlineChart(){
      const canvas = qs('#inlineChart'), msg = qs('#noChartMsg'), wrap = qs('#inlineChartWrap');
      function showNoData(){ if (inlineChart) { inlineChart.destroy(); inlineChart = null; } canvas.style.display='none'; msg.style.display='block'; }
      if (!window.chartData) return showNoData();
      const { tensions, depths, results, mode, display, xStepInput } = window.chartData;
      if (!Array.isArray(depths) || !depths.length) return showNoData();

      const xMin = parseFloat(qs('#xMin').value), xMax = parseFloat(qs('#xMax').value);
      const yMin = parseFloat(qs('#yMin').value), yMax = parseFloat(qs('#yMax').value);
      const yStep = parseFloat(qs('#yStep').value), minor = qs('#minorGrid').checked;

      let datasets = [];
      if (mode === 'compare') {
        datasets = tensions.map(bt => ({
          label: bt + ' kg',
          data: toPoints(depths, depths.map((_,ix)=> results[bt]?.[ix]?.[display])),
          borderWidth: 2, fill: false, spanGaps: true
        }));
      } else {
        const bt = tensions[0];
        const mk = key => toPoints(depths, depths.map((_,ix)=> results[bt]?.[ix]?.[key]));
        datasets = [
          { label:'Layback',     data: mk('layback'),    borderWidth:2, fill:false, spanGaps:true },
          { label:'Length',      data: mk('length'),     borderWidth:2, fill:false, spanGaps:true },
          { label:'Angle',       data: mk('angle'),      borderWidth:2, fill:false, spanGaps:true },
          { label:'Top Tension', data: mk('topTension'), borderWidth:2, fill:false, spanGaps:true }
        ];
      }
      const rng = minMaxFromDatasets(datasets); if (!rng) return showNoData();

      const w = Math.max(320, wrap.clientWidth - 12); canvas.width = w; canvas.height = 300;
      if (inlineChart) { inlineChart.destroy(); inlineChart = null; }
      const ctx = canvas.getContext('2d');

      inlineChart = new Chart(ctx, {
        type:'line',
        data:{ datasets },
        options:{
          responsive:false, maintainAspectRatio:false, parsing:false, animation:false,
          plugins:{ legend:{ position:'top' }, minorGrid:{ enabled: minor, xStep: xStepInput, yStep: Number.isFinite(yStep)? yStep : undefined } },
          scales:{
            x:{ type:'linear', title:{ display:true, text:'Depth (m)' },
                min: Number.isFinite(xMin) ? xMin : undefined,
                max: Number.isFinite(xMax) ? xMax : undefined,
                ticks:{ stepSize: xStepInput } },
            y:{ title:{ display:true, text:(mode==='compare' ? (display==='angle' ? 'angle (° from vertical)' : display) : 'Value') },
                min: Number.isFinite(yMin) ? yMin : rng.min,
                max: Number.isFinite(yMax) ? yMax : rng.max,
                ticks:{ stepSize: Number.isFinite(yStep) ? yStep : undefined } }
          }
        }
      });
      canvas.style.display='block'; msg.style.display='none';
    }

    /* ---------- Pop-out chart with printed inputs header ---------- */
    function openChartWindow(){
  if(!window.chartData){ alert('Generate the table first!'); return; }
  const { tensions, depths, results, mode, display, xStepInput, weights } = window.chartData;

  const xMin = parseFloat(document.querySelector('#xMin').value),
        xMax = parseFloat(document.querySelector('#xMax').value),
        yMin = parseFloat(document.querySelector('#yMin').value),
        yMax = parseFloat(document.querySelector('#yMax').value),
        yStep = parseFloat(document.querySelector('#yStep').value),
        minor = document.querySelector('#minorGrid').checked;

  const tensionsLabel = (mode==='compare'
    ? tensions.map(t=>`${t}kg`).join(', ')
    : `${tensions[0]}kg (primary)`);
  const paramLabel = (mode==='compare'
    ? (display==='angle' ? 'angle (° from vertical)' : display)
    : 'Detail (primary)');

  function toPoints(depths, arr){
    const pts=[]; for(let i=0;i<depths.length;i++){
      const x=+depths[i], y=+arr[i];
      pts.push((isFinite(x)&&isFinite(y))?{x,y}:{x,y:null});
    } return pts;
  }

  let datasets=[];
  if (mode === 'compare') {
    datasets = tensions.map(bt => ({
      label: bt+' kg',
      data: toPoints(depths, depths.map((_,ix)=>results[bt]?.[ix]?.[display])),
      borderWidth: 2, fill:false, spanGaps:true
    }));
  } else {
    const bt = tensions[0];
    const mk = key => toPoints(depths, depths.map((_,ix)=>results[bt]?.[ix]?.[key]));
    datasets = [
      { label:'Layback', data:mk('layback'), borderWidth:2, fill:false, spanGaps:true },
      { label:'Length', data:mk('length'), borderWidth:2, fill:false, spanGaps:true },
      { label:'Angle', data:mk('angle'), borderWidth:2, fill:false, spanGaps:true },
      { label:'Top Tension', data:mk('topTension'), borderWidth:2, fill:false, spanGaps:true }
    ];
  }
  const nums=[]; datasets.forEach(ds=>ds.data.forEach(p=>{ if(p && isFinite(p.y)) nums.push(p.y); }));
  if(!nums.length){ alert('No numeric data to chart.'); return; }
  let ymin = isFinite(yMin)? yMin : Math.min(...nums),
      ymax = isFinite(yMax)? yMax : Math.max(...nums);
  if(ymin===ymax){ const pad=Math.abs(ymin)*0.05||1; ymin-=pad; ymax+=pad; }
  const span=ymax-ymin, pad=span*0.05; ymin-=pad; ymax+=pad;

  const W = 880, H = 560;
  const w = window.open('', 'ChartWindow', `width=${W+40},height=${H+160}`);
  w.document.write("<html><head><title>Catenary Chart</title>");
  w.document.write(`
    <style>
      body{font-family:Arial;margin:12px}
      button{padding:6px 10px;margin-bottom:8px}
      .metaBox{
        border:1px solid #cfd6df;background:#e7eef7;
        border-radius:6px;padding:8px 10px;margin:6px 0 10px
      }
      .metaLine{margin:2px 0;font-size:12px}
      .metaLine strong{font-weight:700}
    </style>
  `);
  w.document.write("<script src='https://cdn.jsdelivr.net/npm/chart.js'><\/script>");
  // minor-grid plugin (same look as inline)
  w.document.write("<script>const minorGridPlugin={id:'minorGrid',afterDraw(c,a,o){if(!o||!o.enabled)return;const x=c.scales.x,y=c.scales.y,ctx=c.ctx;ctx.save();ctx.strokeStyle='rgba(0,0,0,0.07)';ctx.lineWidth=.5;if(Number.isFinite(o.xStep)&&x&&x.min!=null&&x.max!=null){const dx=o.xStep/2;for(let v=x.min+dx;v<x.max-1e-9;v+=o.xStep){const px=x.getPixelForValue(v);ctx.beginPath();ctx.moveTo(px,y.top);ctx.lineTo(px,y.bottom);ctx.stroke();}}if(Number.isFinite(o.yStep)&&y&&y.min!=null&&y.max!=null){const dy=o.yStep/2;for(let v=y.min+dy;v<y.max-1e-9;v+=o.yStep){const py=y.getPixelForValue(v);ctx.beginPath();ctx.moveTo(x.left,py);ctx.lineTo(x.right,py);ctx.stroke();}}ctx.restore();}};Chart.register(minorGridPlugin);<\/script>");
  w.document.write("</head><body>");
  w.document.write("<button onclick='window.print()'>Print Chart</button><br>");
  w.document.write(`
    <div class="metaBox">
      <div class="metaLine"><strong>Inputs:</strong>
        weight in water: ${weights.water} kg/m &nbsp;·&nbsp;
        weight in air: ${weights.air} kg/m &nbsp;·&nbsp;
        sheave height: ${weights.sheave} m
      </div>
      <div class="metaLine">
        <strong>Bottom tensions:</strong> ${tensionsLabel}
        &nbsp; | &nbsp; <strong>Parameter:</strong> ${paramLabel}
      </div>
    </div>
  `);
  w.document.write(`<canvas id='chartPop' width='${W}' height='${H}'></canvas>`);
  w.document.write("<script>");
  w.document.write(`
    const ctx = document.getElementById('chartPop').getContext('2d');
    const datasets = ${JSON.stringify(datasets)};
    new Chart(ctx, {
      type:'line',
      data:{ datasets },
      options:{
        responsive:false, maintainAspectRatio:false, parsing:false, animation:false,
        plugins:{ legend:{ position:'top' },
                  minorGrid:{ enabled:${minor}, xStep:${xStepInput}, yStep:${isFinite(yStep)?yStep:'null'} } },
        scales:{
          x:{ type:'linear', title:{ display:true, text:'Depth (m)'},
              min:${isFinite(xMin)?xMin:'null'}, max:${isFinite(xMax)?xMax:'null'},
              ticks:{ stepSize:${xStepInput} } },
          y:{ title:{ display:true, text:'${(mode==='compare' ? (display==='angle' ? 'angle (° from vertical)' : display) : 'Value') }'},
              min:${ymin}, max:${ymax},
              ticks:{ stepSize:${isFinite(yStep)?yStep:'null'} } }
        }
      }
    });
  `);
  w.document.write("<\/script></body></html>");
  w.document.close();
}

    /* ---------- Highlighter (unchanged) ---------- */
    function setHiEnabled(on){
      ['hiStart','hiEnd','hiUp','hiDown','hiClear'].forEach(id=>{ const el=document.getElementById(id); el.disabled=!on; });
      document.getElementById('hiHint').textContent = on ? 'Use sliders or click-drag on the table.' : 'Turn on to use sliders or click-drag on the table.';
      if(!on) clearBand();
    }
    document.getElementById('hiEnable').addEventListener('change', (e)=>{
      setHiEnabled(e.target.checked);
      localStorage.setItem('hiEnabled', e.target.checked ? '1' : '0');
    });
    (function restoreHiState(){
      const on = localStorage.getItem('hiEnabled') === '1';
      document.getElementById('hiEnable').checked = on; setHiEnabled(on);
    })();

    function initRangeHighlighter(depths){
      const start = document.getElementById('hiStart');
      const end = document.getElementById('hiEnd');
      start.max = end.max = depths.length;
      if(+start.value>depths.length) start.value = 1;
      if(+end.value>depths.length) end.value = 1;

      const syncLabels = () => {
        document.getElementById('hiStartLbl').textContent = start.value;
        document.getElementById('hiEndLbl').textContent = end.value;
        const [s,e] = [Math.min(+start.value,+end.value), Math.max(+start.value,+end.value)];
        const sDepth = depthAtRow(s), eDepth = depthAtRow(e);
        document.getElementById('hiReadout').textContent = `Depths: ${sDepth} m → ${eDepth} m`;
      };

      start.oninput = ()=>{ if(!document.getElementById('hiEnable').checked) return; setRange(+start.value, +end.value); syncLabels(); };
      end.oninput   = ()=>{ if(!document.getElementById('hiEnable').checked) return; setRange(+start.value, +end.value); syncLabels(); };
      syncLabels();

      document.getElementById('hiUp').onclick = ()=>{
        if(!document.getElementById('hiEnable').checked) return;
        const s=Math.max(1, +start.value-1), e=Math.max(1, +end.value-1);
        start.value=s; end.value=e; setRange(s,e,true); syncLabels();
      };
      document.getElementById('hiDown').onclick = ()=>{
        if(!document.getElementById('hiEnable').checked) return;
        const limit = document.querySelectorAll('#resultTable tbody tr').length;
        const s=Math.min(limit, +start.value+1), e=Math.min(limit, +end.value+1);
        start.value=s; end.value=e; setRange(s,e,true); syncLabels();
      };
      document.getElementById('hiClear').onclick = ()=>{ clearBand(); };
    }

    function depthAtRow(idx){
      const tr = document.querySelector(`#resultTable tbody tr:nth-child(${idx})`);
      return tr ? tr.cells[0].textContent : '–';
    }
    function setRange(a,b,scroll=false){
      if(!document.getElementById('hiEnable').checked) return;
      const table = document.getElementById('resultTable'); if(!table) return;
      const rows = [...table.querySelectorAll('tbody tr')];
      rows.forEach(r=>r.classList.remove('band','cursor'));
      const s = Math.max(1, Math.min(a,b)), e = Math.min(rows.length, Math.max(a,b));
      for(let i=s-1;i<=e-1;i++) rows[i].classList.add('band');
      rows[e-1]?.classList.add('cursor');
      if(scroll && rows[s-1]) rows[s-1].scrollIntoView({block:'nearest'});
    }
    function hookRowSelection(){
      const tbody = document.querySelector('#resultTable tbody'); if(!tbody) return;
      let dragging=false, startRow=null;
      tbody.addEventListener('mousedown', (e)=>{
        if(!document.getElementById('hiEnable').checked) return;
        const tr=e.target.closest('tr'); if(!tr) return;
        dragging=true; startRow=+tr.dataset.row; setRange(startRow,startRow); updateRangeSliders(startRow,startRow);
      });
      tbody.addEventListener('mousemove', (e)=>{
        if(!dragging || !document.getElementById('hiEnable').checked) return;
        const tr=e.target.closest('tr'); if(!tr) return;
        setRange(startRow,+tr.dataset.row); updateRangeSliders(startRow,+tr.dataset.row);
      });
      window.addEventListener('mouseup', ()=> dragging=false);
    }
    function updateRangeSliders(a,b){
      const start=document.getElementById('hiStart'), end=document.getElementById('hiEnd');
      start.value=Math.min(a,b); end.value=Math.max(a,b);
      const sDepth=depthAtRow(+start.value), eDepth=depthAtRow(+end.value);
      document.getElementById('hiStartLbl').textContent=start.value;
      document.getElementById('hiEndLbl').textContent=end.value;
      document.getElementById('hiReadout').textContent=`Depths: ${sDepth} m → ${eDepth} m`;
    }
    function clearBand(){
      const table = document.getElementById('resultTable'); if(!table) return;
      [...table.querySelectorAll('tbody tr')].forEach(r=>r.classList.remove('band','cursor'));
      document.getElementById('hiReadout').textContent = 'Depths: –';
    }
  </script>
</body>
</html>





