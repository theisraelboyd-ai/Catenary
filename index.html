<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catenary Suite - Precision Desktop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- GLOBAL RESET --- */
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --brand: #004080; --bg: #f0f2f5; --panel: #ffffff;
            --border: #d1d5db; --accent: #15803d; --danger: #b91c1c; 
            --sidebar-w: 360px;
            --text-main: #1f2937; --text-muted: #6b7280;
            --hl-color: #fff9c4;
            --crit-bg: #fff1f2; --crit-text: #9f1239; --crit-border: #fca5a5;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* --- LAYOUT --- */
        .app-view { display: flex; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-w); background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 20; }
        .table-view { flex: 1.6; display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); background: #fff; }
        .chart-view { flex: 1; display: flex; flex-direction: column; padding: 20px; background: #f8f9fa; }

        /* --- MOBILE NAV --- */
        .mobile-nav { display: none; }
        @media screen and (max-width: 1024px) {
            body { flex-direction: column; }
            .sidebar, .table-view, .chart-view { display: none; width: 100%; height: 100dvh; border: none; padding: 15px; overflow-y: auto; padding-bottom: 140px !important; }
            .active-mobile-view { display: flex !important; animation: fadeIn 0.2s ease-out; }
            .mobile-nav { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 60px; background: #fff; border-top: 1px solid #ddd; position: fixed; bottom: 0; width: 100%; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
            .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-top: 3px solid transparent; }
            .nav-item.active { color: var(--brand); border-top-color: var(--brand); background: #f8faff; }
            .nav-icon { font-size: 18px; margin-bottom: 3px; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- UI ELEMENTS --- */
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        .panel-title { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--brand); letter-spacing: 0.5px; }
        .section-title { margin: 20px 0 8px 0; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .instruction { font-size: 12px; color: #4b5563; margin-bottom: 12px; }
        .panel-instruction { font-size: 12px; color: #4b5563; margin-bottom: 12px; margin-top:-5px; }

        /* Inputs & Buttons */
        .input-row { display: grid; grid-template-columns: 1fr 125px; gap: 10px; margin-bottom: 8px; align-items: center; font-size: 13px; font-weight: 500; }
        input[type="number"], select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; text-align: center; width: 100%; font-family: inherit; }
        .btn { padding: 10px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 8px; font-size: 13px; transition: all 0.2s; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-lite { background: #fff; border: 1px solid #d1d5db; color: var(--text-main); padding: 8px; }
        .btn-md { padding: 5px 12px; font-size: 11px; width: auto; background: #fff; border: 1px solid var(--brand); color: var(--brand); border-radius: 4px; }
        .btn-danger { background: #fff1f0; color: #e11d48; border: 1px solid #fda4af; cursor: pointer; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-info { font-size: 11px; background: none; border: none; color: var(--text-muted); text-decoration: underline; cursor: pointer; padding: 0; margin-bottom: 10px; text-align: left; }

        .solver-actions { display: grid; grid-template-columns: 3fr 1fr; gap: 8px; margin-top: 8px; }
        .btn-solver { background: var(--accent); color: white; margin-top: 0; }
        .btn-clear { background: #fff1f0; color: var(--danger); border: 1px solid #ffa39e; margin-top: 0; }

        .sidebar-result { margin-top: 10px; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; border-left: 4px solid var(--accent); display: none; }
        .sb-res-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .sb-res-label { font-size: 10px; font-weight: 700; color: #166534; text-transform: uppercase; }
        .sb-res-val { font-size: 13px; font-weight: 700; color: #14532d; }

        .param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .big-check { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; background: #fff; }
        .big-check span { font-size: 12px; font-weight: 600; }
        .tension-tag { display: inline-flex; align-items: center; background: #eef2ff; color: var(--brand); padding: 3px 8px; border-radius: 4px; margin: 3px; font-size: 11px; font-weight: 700; border: 1px solid #c7d2fe; }
        .tension-tag span { margin-left: 6px; cursor: pointer; color: #ef4444; }

        /* --- TABLE --- */
        .table-wrapper { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; text-align: center; }
        th { position: sticky; top: 0; z-index: 10; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(8px); padding: 10px 6px; font-weight: 700; color: var(--text-muted); border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
        
        /* Sticky Left Column */
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 11; background: #fff; border-right: 2px solid var(--border); }
        th:first-child { z-index: 12; }
        
        td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; font-variant-numeric: tabular-nums; }
        tr:hover td { background-color: #f8fafc; }
        tr.highlighted-row td { background-color: var(--hl-color) !important; border-top: 1px solid #fce788; border-bottom: 1px solid #fce788; font-weight: 700; color: #333; }
        
        /* CELL-SPECIFIC Critical Styling */
        td.cell-crit { 
            background-color: var(--crit-bg); 
            color: var(--crit-text);
        }
        
        .cascade-row { animation: waterfall 0.3s ease-out forwards; opacity: 0; }
        @keyframes waterfall { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CHART CONTROLS --- */
        .chart-controls { padding: 12px; background: #fff; border: 1px solid var(--border); border-radius: 4px; margin-top: 15px; }
        .range-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; }
        .range-group:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .range-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .range-label { font-size: 10px; font-weight: 800; color: #4b5563; text-transform: uppercase; }
        .range-values { display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .micro-input { width: 45px !important; flex: 0 0 45px; padding: 2px 0 !important; text-align: center; font-size: 11px; height: 24px; border: 1px solid #d1d5db; border-radius: 3px; font-weight: 600; color: var(--text-main); }
        .slider-row { display: flex; width: 100%; margin-top: 6px; }
        .hybrid-slider { flex: 1; accent-color: var(--brand); cursor: pointer; height: 4px; width: 100%; }

        /* --- SOLVER PANEL --- */
        .solver-panel { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; padding: 12px; margin-bottom: 15px; display: none; border-left: 4px solid var(--accent); }
        .solver-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .res-item { display: flex; flex-direction: column; }
        .res-label { font-size: 9px; color: #166534; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; } 
        .res-val { font-size: 16px; font-weight: 800; color: #14532d; font-family: 'Segoe UI', sans-serif; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 30px; border-radius: 6px; width: 700px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        .math-row { font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; margin: 8px 0; border-radius: 4px; font-size: 13px; border-left: 4px solid var(--brand); color: #334155; }
        .help-section { margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; padding-bottom: 16px; }
        .help-title { margin:0 0 8px 0; color:var(--text-main); font-size:16px; font-weight:700; }
        .help-text { font-size:13px; line-height:1.6; color:#475569; margin-bottom:8px; }

        /* --- HIGHLIGHTER --- */
        .hl-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; background: #fff; border: 1px solid var(--border); border-bottom: none; padding: 8px 12px; border-radius: 4px 4px 0 0; justify-content: center; }
        .hl-active { background: #fffbeb; border-color: #fcd34d; }
        .hl-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .hl-slider { flex: 1; accent-color: #f59e0b; cursor: pointer; min-width: 100px; }
        .hl-btn { padding: 3px 8px; font-size: 10px; cursor: pointer; background: white; border: 1px solid #d1d5db; border-radius: 3px; font-weight: 600; color: var(--text-main); }
    </style>
</head>
<body>

<div id="mathModal" class="modal-overlay" onclick="toggleMath(false)">
    <div class="modal-card" onclick="event.stopPropagation()">
     <div style="border-bottom: 1px solid #e2e8f0; margin-bottom: 25px; padding-bottom: 15px;">
            <h2 style="margin: 0; color: var(--brand); font-family: 'Georgia', serif; font-size: 26px; font-weight: 700; letter-spacing: -0.5px;">The Physics of Cable Deployment</h2>
            <p style="margin: 8px 0 0 0; color: #64748b; font-size: 15px; font-weight: 400; line-height: 1.6; font-style: italic;">
                A comprehensive field guide to the mechanics, mathematics, and operational realities governing this analysis engine.
            </p>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">1. First Principles: The Catenary & Parameter 'a'</h4>
            <p class="help-text">
                Let us begin with the basics. When a uniform flexible cable hangs under its own weight between two points, it does not form a parabola, nor a straight line. It forms a specific geometric shape known as a <strong>Catenary</strong>.
            </p>
            <p class="help-text">
                The shape of this curve is governed by a single "Master Number" known as the <strong>Catenary Parameter (a)</strong>. You can think of <em>a</em> as the "Stiffness" of the curve.
            </p>
            <div style="background: #f0f9ff; padding: 15px; border-left: 4px solid #0ea5e9; margin: 15px 0; border-radius: 4px;">
                <strong style="color: #0369a1; font-size: 13px; text-transform: uppercase;">The Definition of 'a'</strong>
                <p style="margin: 5px 0 0 0; font-size: 14px; color: #0c4a6e; font-family: 'Courier New', monospace; font-weight: 600;">a = H / q</p>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: #334155; line-height: 1.5;">
                    Where <strong>H</strong> is the Horizontal Tension (pull) and <strong>q</strong> is the Weight of the cable per metre.
                </p>
            </div>
            <ul style="padding-left: 20px; margin-top: 10px; list-style-type: circle; color: #475569; font-size: 13px; line-height: 1.6;">
                <li><strong>High Tension:</strong> <em>a</em> is large. The curve is flat and tight (like a guitar string).</li>
                <li><strong>Low Tension:</strong> <em>a</em> is small. The curve is deep and baggy (like a slack chain).</li>
            </ul>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">2. The Shallow Water Problem: Air vs. Water</h4>
            <p class="help-text">
                Standard calculators assume the cable is entirely underwater. In deep water, this is a safe assumption. However, in shallow water (e.g., shore landings), we encounter a significant physical change.
            </p>
            <p class="help-text">
                Imagine you are standing on a high balcony lowering a heavy chain down to a swimming pool below:
            </p>
            <ul style="padding-left: 20px; margin-top: 10px; margin-bottom: 15px; list-style-type: square; color: #475569; font-size: 13px; line-height: 1.6;">
                <li><strong>In Water ($q_1$):</strong> The moment the chain hits the water, it becomes lighter due to buoyancy. The water supports it, allowing it to form a gentle curve.</li>
                <li><strong>In Air ($q_2$):</strong> The section hanging from your hands to the surface has no support. It bears its full weight. It pulls down aggressively, creating a steep, heavy curve.</li>
            </ul>
            <p class="help-text">
                <strong>The Solution:</strong> This engine uses a "Two-Segment" approach. We calculate the "Air Curve" and the "Water Curve" separately using their respective weights, and then mathematically fuse them at the sea surface. This eliminates the "ghost" errors found in simpler calculators.
            </p>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">3. Friction: The Mechanical Lever</h4>
            <p class="help-text">
                In heavy power cable installation, friction is not an annoyance; it is a mechanical tool. As the cable passes over the overboard chute (sheave), the interaction is governed by the <strong>Capstan Equation</strong>.
            </p>
            <div style="background: #fffbeb; padding: 15px; border-radius: 4px; border: 1px solid #fcd34d; margin: 15px 0;">
                <strong style="color: #92400e; font-size: 13px; text-transform: uppercase;">Operational Context: Lubrication Strategy</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: #78350f; line-height: 1.6;">
                    The friction coefficient (Œº) determines how much the chute interacts with the cable.
                </p>
                <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #78350f; line-height: 1.6;">
                    <li><strong>Laying (High Friction/Dry):</strong> We typically keep the chute dry. The steel surface "grips" the cable, passively holding back the weight. This reduces the load on the tensioner significantly.</li>
                    <li><strong>Recovery (Low Friction/Wet):</strong> When hauling in, that same friction fights against the winch, adding drag. We apply water here purely for <strong>lubrication</strong>‚Äîto lower the friction coefficient, allowing the cable to slide easier and reducing torque demand.</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">4. The "Critical Zone" (Hatched Red Area)</h4>
            <p class="help-text">
                You will observe a hatched red zone on the Dynamic Profile chart. This represents the <strong>Critical Water Depth (CWD)</strong>.
            </p>
            <p class="help-text">
                For any given tension, there is a specific depth where the "Air Segment" becomes the dominant force. If your operation enters this red zone:
            </p>
            <ul style="padding-left: 20px; margin-top: 5px; list-style-type: circle; color: #475569; font-size: 13px;">
                <li>The physics become unstable.</li>
                <li>The Minimum Bending Radius (MBR) tightens rapidly.</li>
                <li>Small vessel movements cause massive tension spikes.</li>
            </ul>
            <p class="help-text">
                The boundary line is calculated using a high-order polynomial derived from the reference paper. It serves as a strict caution indicator for the deck team.
            </p>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">5. The Mathematical Formulary</h4>
            <p class="help-text">For those wishing to verify the engine's output manually:</p>
            
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="margin-bottom: 25px;">
                    <strong style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">I. Geometry (The Curve)</strong>
                    <div style="font-family: 'Courier New', monospace; font-size: 13px; color: #334155; background: white; padding: 8px; border: 1px solid #cbd5e1; margin-top: 5px;">
                        y = a ¬∑ [cosh(x / a) - 1]
                    </div>
                    <p style="font-size: 11px; color: #94a3b8; margin-top: 4px;">("cosh" is the Hyperbolic Cosine function)</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <strong style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">II. Top Tension (Forces)</strong>
                    <div style="font-family: 'Courier New', monospace; font-size: 13px; color: #334155; background: white; padding: 8px; border: 1px solid #cbd5e1; margin-top: 5px;">
                        Top Tension = ‚àö ( H¬≤ + V¬≤ )
                    </div>
                    <p style="font-size: 11px; color: #94a3b8; margin-top: 4px;">(Where H is Bottom Tension, V is Total Suspended Weight)</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <strong style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">III. Capstan Friction (Winch Load)</strong>
                    <div style="font-family: 'Courier New', monospace; font-size: 13px; color: #334155; background: white; padding: 8px; border: 1px solid #cbd5e1; margin-top: 5px;">
                        T_winch = T_sheave / e^(Œº ¬∑ &theta;)
                    </div>
                    <p style="font-size: 11px; color: #94a3b8; margin-top: 4px;">(Where &theta; is the exit angle in radians)</p>
                </div>

                <div>
                    <strong style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">IV. Critical Water Depth (The Red Zone)</strong>
                    <div style="font-family: 'Courier New', monospace; font-size: 13px; color: #334155; background: white; padding: 8px; border: 1px solid #cbd5e1; margin-top: 5px;">
                        CWD = 0.069H<sup>4</sup> - 1.23H<sup>3</sup> + 6.54H<sup>2</sup> + 2.9H + 3.15
                    </div>
                    <p style="font-size: 11px; color: #94a3b8; margin-top: 4px;">(Where H is Bottom Tension in Tonnes-Force)</p>
                </div>
            </div>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">6. Operational User Guide</h4>
            <p class="help-text">How to utilize the Catenary Suite for mission planning and live monitoring.</p>

            <div style="margin-bottom: 20px;">
                <strong style="color: var(--brand); font-size: 14px;">Section 1: Environmental Inputs (Mission Parameters)</strong>
                <p class="help-text">
                    This is where you define the physical constraints of the operation. Ensure you input the distinct weights for <strong>Water</strong> and <strong>Air</strong>‚Äîthe difference between these two drives the physics engine. Set your friction (micro) based on your mode: <strong>0.3-0.5</strong> for laying, <strong>0.1-0.2</strong> for recovery.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <strong style="color: var(--brand); font-size: 14px;">Section 2: Tension Comparison (Scenario Building)</strong>
                <p class="help-text">
                    Cable laying is rarely static. Use the <strong>"Add to Comparison"</strong> button to layer multiple tension curves onto the graph (e.g., Minimum, Target, Maximum). This creates an "Operating Envelope" on the chart, allowing the bridge team to visualize the safe window.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <strong style="color: var(--brand); font-size: 14px;">Section 4: The "As-Laid" Solver (Field Verification)</strong>
                <p class="help-text">
                    During operations, you often know the ROV position (Depth/Layback) but need to verify the tension. Input your observed data here and click <strong>"Calc 'As-Laid'"</strong>. The system will reverse-calculate the required bottom tension and plot a <span style="color:#16a34a; font-weight:bold;">Green Target Line</span> on the chart for visual comparison.
                </p>
            </div>
        </div>

        <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">7. Field Tools & Features</h4>
            
            <ul style="padding-left: 20px; list-style-type: disc; color: #475569; font-size: 13px; line-height: 1.6;">
                <li style="margin-bottom: 10px;">
                    <strong>The "Live Laying" Highlighter:</strong> Located above the table. Use the slider or arrow buttons to highlight your current depth row. This acts as a digital ruler for the Shift Supervisor during live ops.
                </li>
                <li style="margin-bottom: 10px;">
                    <strong>Chart Scaling (Targeting):</strong> Use the sliders below the chart to zoom in. If you are doing a shore landing (0-20m), restrict the X-Axis to focus purely on the Touch Down Point (TDP).
                </li>
                <li style="margin-bottom: 10px;">
                    <strong>Reporting:</strong> Use <strong>"Print Table"</strong> for a high-contrast report where Critical Zones are clearly marked in red. Use <strong>"Pop-out"</strong> on the chart to move the graph to a secondary bridge monitor.
                </li>
                <li>
                    <strong>System Reset:</strong> The "Reset All" button (top right) performs a hard reset, clearing all data and restoring default physics constants.
                </li>
            </ul>
        </div>

      <div class="help-section">
            <h4 class="help-title" style="font-family: 'Georgia', serif; color: var(--brand); border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 15px;">A Note on Angle Discrepancies: The "Stiffness Offset"</h4>
            
            <p class="help-text">
                You may observe a small discrepancy (typically 2¬∞‚Äì5¬∞) between the <strong>Exit Angle</strong> calculated by this tool and the reading on your deck clinometer. This is not a calculation error; it is a physical phenomenon known as <strong>Bending Stiffness ($EI$)</strong>.
            </p>
            
            <div style="margin-top: 15px;">
                <strong style="color: #334155; font-size: 13px;">The "Perfect String" Assumption</strong>
                <p class="help-text">
                    The Catenary mathematical model assumes the cable is "perfectly flexible"‚Äîlike a heavy chain or a wet rope. It assumes the cable has <strong>zero resistance</strong> to bending. Under this assumption, gravity pulls the cable into a perfect vertical tangent at the sheave.
                </p>
            </div>

            <div style="margin-top: 15px;">
                <strong style="color: #334155; font-size: 13px;">The "Steel Bar" Reality</strong>
                <p class="help-text">
                    In reality, a large power cable (e.g., 150mm diameter) behaves more like a steel bar. It has significant stiffness. While gravity tries to pull it straight down, the cable's own internal structure resists this sharp bend.
                </p>
                <p class="help-text">
                    This stiffness "pushes" the cable outward slightly as it leaves the chute, resulting in a <strong>flatter angle</strong> (a higher number) than pure gravity predicts.
                </p>
            </div>

            <div style="background: #fffbeb; padding: 12px; border-left: 4px solid #f59e0b; margin-top: 15px; border-radius: 2px;">
                <strong style="color: #92400e; font-size: 12px; text-transform: uppercase;">Practical Application</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: #78350f; line-height: 1.5;">
                    Treat the tool's calculated angle as the <strong>"Gravity Baseline"</strong>. Your actual measured angle will almost always be slightly higher (flatter) due to this stiffness. If the tool says 12¬∞ and you measure 15¬∞, this confirms the cable is behaving structurally as expected.
                </p>
            </div>
        </div>
        <div style="margin-top: 40px; border-top: 1px solid #cbd5e1; padding-top: 20px;">
            <p style="font-size: 13px; color: #334155; font-weight: 700; text-transform: uppercase; margin-bottom: 10px;">Primary Scientific Reference</p>
            <p style="font-size: 13px; color: #475569; margin: 0; line-height: 1.6;">
                This engine has been calibrated against the theoretical framework established in:
                <br><br>
                <strong>Mamatsopoulos, V.A., Michailides, C., Theotokoglou, E.E., & Onoufriou, T. (2020).</strong><br> 
                <em>"Critical Water Depth and Installation Curves for Submarine Cable Deployment Process."</em><br> 
                Journal of Marine Science and Engineering, 8(11), 838.
            </p>
            <div style="margin-top: 15px;">
                <a href="https://doi.org/10.3390/jmse8110838" target="_blank" style="display: inline-block; background: #f1f5f9; color: var(--brand); padding: 8px 15px; border-radius: 4px; text-decoration: none; font-weight: 600; font-size: 12px; border: 1px solid #cbd5e1;">
                    Read Full Paper (MDPI) &rarr;
                </a>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; margin-bottom: 10px;">
            <button class="btn btn-primary" style="width: auto; padding: 12px 40px; font-weight: 600; letter-spacing: 0.5px;" onclick="toggleMath(false)">Return to Analysis</button>
        </div>
       </div>
</div>

<div class="app-view">
    <div id="tab-config" class="sidebar active-mobile-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <h3 style="margin:0; color:var(--brand);">Catenary Suite</h3>
            <button class="btn btn-danger btn-md" onclick="resetAll()" style="font-size:10px; padding:4px 8px;">‚Üª Reset All</button>
        </div>
        <button class="btn-info" onclick="toggleMath(true)">Read Me - Guide</button>
        
        <div class="section-title">1. Environmental Inputs</div>
        <p class="instruction">Configure cable & geometry.</p>
        <div class="input-row"><span>Wt Water (kg/m)</span><input type="number" id="wW" value="50" inputmode="decimal"></div>
        <div class="input-row"><span>Wt Air (kg/m)</span><input type="number" id="wA" value="60" inputmode="decimal"></div>
        <div class="input-row"><span>Sheave Height (m)</span><input type="number" id="sH" value="1" inputmode="decimal"></div>
        <div class="input-row"><span>Sheave Radius (m)</span><input type="number" id="sR" value="5" inputmode="decimal"></div>
        <div class="input-row"><span>Sheave Friction (Œº)</span><input type="number" id="fric" value="0.3" step="0.1" inputmode="decimal"></div>
        <div class="input-row"><span>Max Depth (m)</span><input type="number" id="mD" value="100" inputmode="decimal"></div>
        <div class="input-row"><span>Depth Step (m)</span><input type="number" id="dS" value="5" inputmode="decimal"></div>

        <div class="section-title">2. Tension Comparison</div>
        <div class="input-row">
            <span>Select Tension</span>
            <select id="tSelect"></select>
        </div>
        <button class="btn btn-lite" onclick="addTension()">+ Add to Comparison</button>
        <div id="tList" style="margin-top:8px; min-height:20px;"></div>

        <div class="section-title">3. Table & Chart Mode</div>
        <div class="param-grid">
            <label class="big-check"><input type="checkbox" class="p-check" value="layback" checked> <span>Layback</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="length" checked> <span>Length</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="angle"> <span>Angle</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="tension"> <span>Tension</span></label>
        </div>

        <button class="btn btn-primary" onclick="runMain(); if(window.innerWidth<=1024) switchTab('tab-chart');">GENERATE DATA</button>

        <div class="section-title" style="margin-top:30px; color:var(--accent); border-color:var(--accent);">4. Raw Data Solver</div>
        <p class="instruction">Enter ANY 2 values to solve.</p>
        <div class="input-row solver-input"><span>Obs Layback</span><input type="number" id="obsL" placeholder="(m)" inputmode="decimal"></div>
        <div class="input-row solver-input"><span>Obs Depth</span><input type="number" id="obsD" placeholder="(m)" inputmode="decimal"></div>
        <div class="input-row solver-input"><span>Obs Angle</span><input type="number" id="obsA" placeholder="(Deg)" inputmode="decimal"></div>
        <div class="solver-actions">
            <button class="btn btn-solver" onclick="solveLive()">Live Catenary Calc</button>
            <button class="btn btn-clear" onclick="clearSolver()">CLEAR</button>
        </div>
        
        <div id="sidebarSolverResult" class="sidebar-result">
            <div class="sb-res-row"><span class="sb-res-label">Target Tension</span><span class="sb-res-val" id="sbResBot">--</span></div>
            <div class="sb-res-row"><span class="sb-res-label">Total Length</span><span class="sb-res-val" id="sbResLen">--</span></div>
            <div class="sb-res-row" style="border-top:1px solid #bbf7d0; padding-top:4px; margin-top:4px;"><span class="sb-res-label" id="sbResExtraLabel">Result</span><span class="sb-res-val" id="sbResExtraVal">--</span></div>
        </div>
    </div>

    <div id="tab-table" class="table-view">
        <div class="panel-header">
            <span class="panel-title">Calculated Results</span>
            <button class="btn btn-md" onclick="printTableWindow()">üñ® Print</button>
        </div>
        <p class="panel-instruction">
            Comprehensive tabular breakdown. 
            <span style="color:#e11d48; font-size:11px; margin-left:8px; font-weight:700;">(Red Highlight = Critical Zone: Air weight dominates)</span>
        </p>
        <div id="hlToolbar" class="hl-toolbar">
            <span class="hl-label">Row Highlighter:</span>
            <input type="range" id="hlSlider" class="hl-slider" min="0" max="0" value="0" disabled>
            <span id="hlReadout" style="font-size:12px; font-weight:bold; min-width:30px; text-align:right;">--</span>
            <button class="hl-btn" onclick="moveHighlight(-1)">‚ñ≤</button>
            <button class="hl-btn" onclick="moveHighlight(1)">‚ñº</button>
            <button class="hl-btn" onclick="clearHighlight()">Clear</button>
        </div>
        <div class="table-wrapper">
            <table id="mainTable"><thead id="tableHdr"></thead><tbody id="tableBdy"></tbody></table>
        </div>
    </div>

    <div id="tab-chart" class="chart-view">
        <div id="solverPanel" class="solver-panel">
            <div style="font-size:11px; font-weight:bold; color:#166534; border-bottom:1px solid #86efac; margin-bottom:12px;">Live Catenary Results</div>
            <div class="solver-grid">
                <div class="res-item"><span class="res-label">Total Length</span><span class="res-val highlight" id="resLen">--</span></div>
                <div class="res-item"><span class="res-label">Bottom Tension</span><span class="res-val" id="resBot">--</span></div>
                <div class="res-item"><span class="res-label">Dep. Angle (Vert)</span><span class="res-val" id="resMissing">--</span></div>
            </div>
        </div>

        <div class="panel-header">
            <span class="panel-title">Dynamic Profile</span>
            <button class="btn btn-md" onclick="popChartWindow()">‚§¢ Pop-out</button>
        </div>
        <div style="font-size:11px; color:#555; background:#fff; padding:6px 10px; border:1px solid #eee; border-radius:4px; margin-bottom:10px;">
            <span style="color:#e11d48; font-weight:800;">‚ñ® CWD ZONE:</span> The <span style="color:#e11d48; text-decoration: underline dashed;">hatched red area</span> represents the Critical Zone. Curves inside this area are unstable/air-dominated.
        </div>
        
        <div style="flex:1; background:white; border:1px solid var(--border); padding:5px; position:relative; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.03); min-height: 250px;">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="chart-controls">
            <div class="range-group">
                <div class="range-header">
                    <span class="range-label">DEPTH</span>
                    <div class="range-values">
                        <input type="number" id="minXBox" class="micro-input" value="0" onchange="sync('minX', 'Box')" inputmode="decimal">
                        <span style="color:#aaa; font-size:10px;">‚Äî</span>
                        <input type="number" id="maxXBox" class="micro-input" value="100" onchange="sync('maxX', 'Box')" inputmode="decimal">
                    </div>
                </div>
                <div class="slider-row">
                    <input type="range" id="minXSlider" class="hybrid-slider" min="0" max="100" value="0" oninput="syncVisual('minX')" onchange="syncFinal('minX')">
                    <input type="range" id="maxXSlider" class="hybrid-slider" min="0" max="100" value="100" oninput="syncVisual('maxX')" onchange="syncFinal('maxX')">
                </div>
            </div>

            <div class="range-group">
                <div class="range-header">
                    <span class="range-label" id="yLabel">LAYBACK (M)</span>
                    <div class="range-values">
                        <input type="number" id="minYBox" class="micro-input" value="0" onchange="sync('minY', 'Box')" inputmode="decimal">
                        <span style="color:#aaa; font-size:10px;">‚Äî</span>
                        <input type="number" id="maxYBox" class="micro-input" value="100" onchange="sync('maxY', 'Box')" inputmode="decimal">
                    </div>
                </div>
                <div class="slider-row">
                    <input type="range" id="minYSlider" class="hybrid-slider" min="0" max="100" value="0" oninput="syncVisual('minY')" onchange="syncFinal('minY')">
                    <input type="range" id="maxYSlider" class="hybrid-slider" min="0" max="100" value="100" oninput="syncVisual('maxY')" onchange="syncFinal('maxY')">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mobile-nav">
    <div class="nav-item active" onclick="switchTab('tab-config', this)"><span class="nav-icon">‚öôÔ∏è</span><span>Config</span></div>
    <div class="nav-item" onclick="switchTab('tab-table', this)"><span class="nav-icon">üìä</span><span>Data</span></div>
    <div class="nav-item" onclick="switchTab('tab-chart', this)"><span class="nav-icon">üìà</span><span>Graph</span></div>
</div>

<script>
    const ACOSH = Math.acosh || function(x){ return Math.log(x + Math.sqrt((x-1)*(x+1))); };
    const SINH  = Math.sinh  || function(x){ const e=Math.exp(x), ei=1/e; return (e-ei)/2; };

    // --- PHYSICS ENGINE ---
    function getCriticalDepth(H_kgf) {
        const H_tf = H_kgf / 1000.0;
        return (0.0698 * Math.pow(H_tf, 4)) - (1.2321 * Math.pow(H_tf, 3)) 
             + (6.5376 * Math.pow(H_tf, 2)) + (2.9029 * H_tf) + 3.1488;
    }

    function solveTwoSegmentSystem(H, WD, wW, wA, chuteH, chuteR, mu) {
        const a1 = H / wW; 
        const term1 = (WD / a1) + 1;
        const x1 = a1 * ACOSH(term1); 
        const L1 = a1 * SINH(x1 / a1); 
        const V_surf = L1 * wW; 

        const a2 = H / wA;
        const L_virt_start = V_surf / wA; 
        const y_virt_start = Math.sqrt(Math.pow(L_virt_start, 2) + Math.pow(a2, 2));
        const y_virt_end = y_virt_start + chuteH;
        
        const x_virt_start = a2 * ACOSH(y_virt_start / a2);
        const x_virt_end   = a2 * ACOSH(y_virt_end / a2);
        const x2 = x_virt_end - x_virt_start; 
        
        const L_virt_end = Math.sqrt(Math.pow(y_virt_end, 2) - Math.pow(a2, 2));
        const L2 = L_virt_end - L_virt_start; 

        const V_out = V_surf + (L2 * wA); 
        const theta_rad = Math.atan(V_surf / H); 
        const theta_deg = (theta_rad * 180) / Math.PI; 
        
        const wrap_angle = (Math.PI / 2) - theta_rad;
        const L_wrap = (chuteR > 0) ? (chuteR * wrap_angle) : 0;

        const T_cable = Math.sqrt(Math.pow(H, 2) + Math.pow(V_out, 2));
        const T_winch = T_cable / Math.exp(mu * theta_rad);

        return { layback: x1 + x2, length: L1 + L2 + L_wrap, angle: 90 - theta_deg, tension: T_winch, cwd: getCriticalDepth(H) };
    }

    function solveAByLayback(x, depth, tol=1e-5, maxIt=50) {
        if(x <= 0 || depth <= 0) return 100;
        let a = (x*x) / (2*depth); if(a < 1) a = 10;
        for(let i=0; i<maxIt; i++) {
            const term = x/a;
            const f = a * (Math.cosh(term) - 1) - depth;
            const df = (Math.cosh(term) - 1) - term*Math.sinh(term);
            if(Math.abs(f) < tol) return a;
            a = a - f/df; if(a <= 0.1) a = 0.1; 
        }
        return a;
    }

    function calcAirLength(sH, sR) {
        if(sR < 0) sR = 0; if(sH < 0) sH = 0;
        if (sH <= sR) return sH + (Math.PI * sR / 4); 
        return (sH - sR) + (Math.PI * sR / 2);
    }

    // --- GRAPHICS UTILS ---
    function createDiagonalPattern(color = '#e11d48') {
        const shape = document.createElement('canvas');
        shape.width = 20; shape.height = 20; // Increased density for print
        const c = shape.getContext('2d');
        c.strokeStyle = color;
        c.lineWidth = 2; 
        c.beginPath(); c.moveTo(0,20); c.lineTo(20,0); c.stroke();
        return c.createPattern(shape, 'repeat');
    }

    // --- APP LOGIC ---
    let activeTensions = [250];
    let solverActive = false;
    let solverTarget = { x:0, y:0 }; 
    let chart;
    let totalRows = 0;
    const colors = ['#004080', '#c0392b', '#8e44ad', '#f39c12', '#2c3e50'];
    let deploymentTimer = null;

    function initDropdown() {
        const select = document.getElementById('tSelect');
        select.innerHTML = ""; 
        for(let i=150; i<=2000; i+=50){
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = i + " kg";
            if(i===250) opt.selected = true;
            select.appendChild(opt);
        }
    }

    function resetAll() {
        // Reset Inputs
        document.getElementById('wW').value = "50";
        document.getElementById('wA').value = "60";
        document.getElementById('sH').value = "1";
        document.getElementById('sR').value = "5";
        document.getElementById('fric').value = "0.3";
        document.getElementById('mD').value = "100";
        document.getElementById('dS').value = "5";
        
        // Wipe Data
        activeTensions = []; 
        document.getElementById('tList').innerHTML = ""; 
        initDropdown();
        clearSolver();

        // Check checkboxes
        document.querySelectorAll('.p-check').forEach(c => c.checked = false);
        document.querySelector('.p-check[value="layback"]').checked = true;

        // Run blank
        runMain();
    }

    function switchTab(tabId, el) {
        if(window.innerWidth > 1024) return; 
        document.querySelectorAll('.sidebar, .table-view, .chart-view').forEach(div => {
            div.classList.remove('active-mobile-view');
        });
        document.getElementById(tabId).classList.add('active-mobile-view');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
        } else {
            const index = (tabId === 'tab-config') ? 0 : (tabId === 'tab-table') ? 1 : 2;
            const items = document.querySelectorAll('.nav-item');
            items.forEach(item => item.classList.remove('active'));
            items[index].classList.add('active');
        }
        window.scrollTo(0,0);
        if(tabId === 'tab-chart' && chart) {
            setTimeout(() => { chart.resize(); }, 100);
        }
    }

    function toggleMath(show) { document.getElementById('mathModal').style.display = show ? 'flex' : 'none'; }
    function addTension() { let val = parseInt(document.getElementById('tSelect').value); if (!activeTensions.includes(val)) { activeTensions.push(val); activeTensions.sort((a,b)=>a-b); updateTensionTags(); } }
    function updateTensionTags() { document.getElementById('tList').innerHTML = activeTensions.map(t => `<span class="tension-tag">${t}kg <span onclick="removeT(${t})">&times;</span></span>`).join(''); }
    function removeT(t) { activeTensions = activeTensions.filter(x => x !== t); updateTensionTags(); }

    function runMain() {
        const wW = parseFloat(document.getElementById('wW').value);
        const wA = parseFloat(document.getElementById('wA').value);
        const sH = parseFloat(document.getElementById('sH').value);
        const sR = parseFloat(document.getElementById('sR').value);
        const mu = parseFloat(document.getElementById('fric').value) || 0;
        const mD = parseFloat(document.getElementById('mD').value);
        const dS = parseFloat(document.getElementById('dS').value);
        const selectedParams = Array.from(document.querySelectorAll('.p-check:checked')).map(c => c.value);
        
        let chartMode = 'layback'; 
        if(selectedParams.length > 0) chartMode = selectedParams[0];

        let headHtml = `<tr><th style="background:#fff;">Depth (m)</th>`;
        activeTensions.forEach((t, i) => { 
            const color = colors[i % colors.length];
            const bgTint = color + '15'; 
            selectedParams.forEach(p => {
                let suffix = "";
                if(p==='layback') suffix="Layback (m)";
                if(p==='length') suffix="Length (m)";
                if(p==='angle') suffix="Angle (¬∞)";
                if(p==='tension') suffix="Top Tens (kg)";
                headHtml += `<th style="border-top: 4px solid ${color}; background: linear-gradient(0deg, ${bgTint}, ${bgTint}), #fff; color:${color};">${t}kg ${suffix}</th>`;
            }); 
        });
        document.getElementById('tableHdr').innerHTML = headHtml;

        let bdyHtml = "";
        const fullDatasets = [];
        const boundaryPoints = []; 
        let rowCount = 0;
        
        // Loop from Step to Max Depth
        for (let d = dS; d <= mD; d += dS) {
            rowCount++;
            let row = `<td>${d}</td>`;
            let anyCriticalInRow = false; 

            activeTensions.forEach((t, i) => {
                const color = colors[i % colors.length];
                let valid = true;
                let isCellCrit = false;
                
                let res = { layback:0, length:0, angle:0, tension:0, cwd:0 };
                try {
                    res = solveTwoSegmentSystem(t, d, wW, wA, sH, sR, mu);
                } catch(e) { valid = false; }

                if (d < res.cwd) { isCellCrit = true; anyCriticalInRow = true; }

                if(valid) {
                    selectedParams.forEach(p => {
                        let val = "";
                        if(p === 'layback') val = res.layback.toFixed(2);
                        if(p === 'length') val = res.length.toFixed(2);
                        if(p === 'angle') val = res.angle.toFixed(1) + "¬∞";
                        if(p === 'tension') val = res.tension.toFixed(0);
                        
                        let cellClass = isCellCrit ? 'cell-crit' : '';
                        row += `<td class="${cellClass}" style="color:${color}; font-weight:600;">${val}</td>`;
                    });
                    
                    let plotVal = res.layback;
                    if(chartMode === 'length') plotVal = res.length;
                    if(chartMode === 'angle') plotVal = res.angle;
                    if(chartMode === 'tension') plotVal = res.tension;

                    if(!fullDatasets[i]) fullDatasets[i] = { 
                        label: t+'kg', data: [], 
                        borderColor: colors[i % colors.length], borderWidth: 2, pointRadius: 0, pointHitRadius: 15 
                    };
                    fullDatasets[i].data.push({x: d, y: plotVal});
                } else {
                    selectedParams.forEach(p => row += `<td style="color:#ccc;">---</td>`);
                    if(!fullDatasets[i]) fullDatasets[i] = { label: t+'kg', data: [], borderColor: colors[i % colors.length] };
                }
            });

            if(anyCriticalInRow) {
                row = row.replace('<td>', '<td class="cell-crit" style="border-left: 4px solid #e11d48; font-weight:bold;">');
            }

            bdyHtml += `<tr id="row-${rowCount}" class="cascade-row" style="animation-delay: ${rowCount * 0.01}s">${row}</tr>`;
        }
        
        // --- ADD HASHED CWD ZONE (BACKGROUND) ---
        // Generates a physics-based Critical Zone curve independent of selection
        if(chartMode === 'layback') {
           const cwdBackground = [];
           
           // Start at 0,0 to anchor the shading
           cwdBackground.push({x: 0, y: 0}); 
           
           // Step through theoretical tensions to build the zone boundary
           for(let h=50; h<=30000; h+=100) {
               const cDepth = getCriticalDepth(h);
               // Ensure we cover the full chart height even if max depth is small
               if(cDepth > Math.max(mD * 1.5, 200)) break; 
               try {
                   const res = solveTwoSegmentSystem(h, cDepth, wW, wA, sH, sR, mu);
                   cwdBackground.push({x: cDepth, y: res.layback});
               } catch(e){}
           }
           
           if(cwdBackground.length > 0) {
               fullDatasets.unshift({
                   label: 'Critical Zone',
                   data: cwdBackground,
                   borderColor: 'rgba(225, 29, 72, 0.0)', // Invisible line
                   borderWidth: 0,
                   pointRadius: 0,
                   fill: 'end', // Fills UP/LEFT (Above the curve)
                   backgroundColor: createDiagonalPattern('rgba(220, 38, 38, 0.25)') // Stronger Red Hatching
               });
           }
        }

        // --- ADD SOLVER LINE IF ACTIVE ---
        // This draws the 'Live Catenary' using the exact tension calculated by the solver
        if(solverActive && chartMode === 'layback' && solverTarget.h > 0) {
            const solverPoints = [];
            
            // We re-run the physics engine using the Calculated Bottom Tension (solverTarget.h)
            // This ensures the green line follows the exact Two-Segment physics, not a guess.
            // We iterate from Depth 0 to Max Depth (mD) to draw the full profile.
            for(let d_step=0; d_step<=mD; d_step+= (mD/100)) { // 100 steps for smoothness
                try {
                    const r = solveTwoSegmentSystem(solverTarget.h, d_step, wW, wA, sH, sR, mu);
                    solverPoints.push({x: d_step, y: r.layback});
                } catch(e) {}
            }
            
            // Push the "Live Catenary" dataset to the chart
            fullDatasets.push({ 
                label: 'Live Catenary', 
                data: solverPoints, 
                borderColor: '#16a34a', // Bright Green to stand out
                borderDash: [6, 4],     // Dashed line to differentiate from static data
                borderWidth: 2, 
                pointRadius: 0,
                tension: 0.4            // Slight smoothing
            });
        }
        
        document.getElementById('tableBdy').innerHTML = bdyHtml;
        totalRows = rowCount;
        const slider = document.getElementById('hlSlider');
        slider.max = totalRows; slider.disabled = false;
        clearHighlight();

        setTimeout(() => { animateDeployment(fullDatasets, chartMode); }, 10);
    }

    function animateDeployment(fullDatasets, mode) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(deploymentTimer) clearInterval(deploymentTimer);
        if (chart) chart.destroy();

        const renderDatasets = fullDatasets.map(ds => ({ ...ds, data: [] }));

        let maxX = 0; let maxY = 0;
        fullDatasets.forEach(ds => { 
            if(ds.label !== 'Critical Zone') { // Ignore background zone for scaling
                ds.data.forEach(p => { if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y; }); 
            }
        });
        if(!maxX || maxX < 10) maxX = 100; if(!maxY || maxY < 10) maxY = 100;

        initFilterGroup('minX', 0, maxX); initFilterGroup('maxX', maxX, maxX);
        initFilterGroup('minY', 0, maxY); initFilterGroup('maxY', maxY, maxY);

        let yTitle = 'Horizontal Layback (m)';
        if(mode === 'length') yTitle = 'Arc Length (m)';
        if(mode === 'angle') yTitle = 'Departure Angle (Vert ¬∞)';
        if(mode === 'tension') yTitle = 'Top Tension (kg)';
        
        document.getElementById('yLabel').innerText = mode.toUpperCase() + " (M)";
        if(mode === 'angle') document.getElementById('yLabel').innerText = "ANGLE (DEG)";
        if(mode === 'tension') document.getElementById('yLabel').innerText = "TENSION (KG)";

        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: renderDatasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: false, 
                layout: { padding: { left: 10, right: 20, top: 20, bottom: 10 } },
                interaction: { mode: 'nearest', intersect: false, axis: 'xy' },
                plugins: {
                    tooltip: { enabled: true, backgroundColor: 'rgba(0,0,0,0.85)', titleFont: { size: 12 }, bodyFont: { size: 12 }, padding: 10, displayColors: true,
                    callbacks: { label: function(c) { return c.dataset.label + ': ' + c.parsed.y.toFixed(2); } } }
                },
                scales: { 
                    x: { type: 'linear', title: { display: true, text: 'Depth (m)' }, min: 0, max: maxX },
                    y: { title: { display: true, text: yTitle }, min: 0, max: maxY } 
                }
            }
        });

        let frameIndex = 0;
        deploymentTimer = setInterval(() => {
            let changed = false;
            fullDatasets.forEach((sourceDs, i) => {
                if(frameIndex < sourceDs.data.length) {
                    chart.data.datasets[i].data.push(sourceDs.data[frameIndex]);
                    changed = true;
                }
            });
            if(changed) { chart.update('none'); frameIndex+=2; } else { clearInterval(deploymentTimer); }
        }, 10);
    }

    function initFilterGroup(prefix, val, maxLimit) {
        const slider = document.getElementById(prefix + 'Slider');
        const box = document.getElementById(prefix + 'Box');
        slider.max = Math.ceil(maxLimit); slider.value = Math.ceil(val); box.value = Math.ceil(val);
    }
    function syncVisual(prefix) { document.getElementById(prefix + 'Box').value = document.getElementById(prefix + 'Slider').value; }
    function syncFinal(prefix) { applyFilters(); }
    function sync(prefix, source) { if(source==='Box') { document.getElementById(prefix+'Slider').value = document.getElementById(prefix+'Box').value; applyFilters(); } }
    
    function applyFilters() {
        if(!chart) return;
        chart.options.scales.x.min = parseFloat(document.getElementById('minXBox').value);
        chart.options.scales.x.max = parseFloat(document.getElementById('maxXBox').value);
        chart.options.scales.y.min = parseFloat(document.getElementById('minYBox').value);
        chart.options.scales.y.max = parseFloat(document.getElementById('maxYBox').value);
        chart.update('none');
    }

    function printTableWindow() {
        const meta = document.querySelector('.sidebar .input-row').parentNode.innerHTML; 
        const wW = document.getElementById('wW').value; const wA = document.getElementById('wA').value; const sH = document.getElementById('sH').value;
        const tableHtml = document.getElementById('mainTable').outerHTML;
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html><html><head><title>Print Table</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>:root { --brand: #004080; --text-main: #2c3e50; --text-muted: #6c757d; --border: #e0e6ed; --crit-bg: #fff1f2; --crit-text: #9f1239; } body { font-family: 'Inter', sans-serif; padding: 40px; color: var(--text-main); -webkit-print-color-adjust: exact; print-color-adjust: exact; } .meta-box { background: #f8f9fa; border: 1px solid #e2e8f0; border-left: 6px solid var(--brand); padding: 20px; margin-bottom: 30px; border-radius: 8px; } table { width: 100%; border-collapse: collapse; font-size: 11px; } th { background-color: #f1f5f9 !important; color: #6c757d; font-weight: 700; text-transform: uppercase; padding: 10px 8px; border-bottom: 2px solid #e0e6ed; -webkit-print-color-adjust: exact; } td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; text-align: center; font-variant-numeric: tabular-nums; } td[style*="color"], th[style*="color"] { -webkit-print-color-adjust: exact; } .cell-crit { background-color: var(--crit-bg) !important; color: var(--crit-text) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } @media print { @page { size: landscape; margin: 15mm; } .btn-print { display: none; } body { padding: 0; } } .btn-print { background: var(--brand); color: white; border: none; padding: 10px 20px; font-weight: 700; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }</style></head><body><button class="btn-print" onclick="window.print()">üñ® Print Report</button><div class="meta-box"><h2 style="margin-top:0; color:var(--brand); font-size:18px;">Catenary Analysis Report</h2><div style="margin-top:10px; font-size:13px;"><strong>Configuration:</strong> Water Wt: ${wW} kg/m | Air Wt: ${wA} kg/m | Sheave H: ${sH} m</div></div>${tableHtml}</body></html>`); w.document.close();
    }

    function popChartWindow() {
        const currentData = chart.config.data; const currentOptions = chart.config.options; const wW = document.getElementById('wW').value; const wA = document.getElementById('wA').value;
        const w = window.open('', '_blank');
        
        // NOTE: We must rebuild the pattern in the new window because JSON.stringify destroys it.
        w.document.write(`<html><head><title>Chart</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script><style>@media print { @page { size: landscape; } body { margin: 0; } .btn-print { display: none; } canvas { max-width: 100%; } } body { font-family: 'Inter', sans-serif; padding: 20px; } .meta { margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-left: 5px solid #004080; border-radius:6px; } .btn-print { background: #004080; color: white; border: none; padding: 10px 20px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }</style></head><body><button class="btn-print" onclick="window.print()">üñ® Print Chart</button><div class="meta"><strong>Catenary Profile</strong> | Wt Water: ${wW} | Wt Air: ${wA}</div><div style="height:80vh"><canvas id="popChart"></canvas></div><script>
        function createPattern(color) { const shape = document.createElement('canvas'); shape.width = 20; shape.height = 20; const c = shape.getContext('2d'); c.strokeStyle = color; c.lineWidth = 2; c.beginPath(); c.moveTo(0,20); c.lineTo(20,0); c.stroke(); return c.createPattern(shape, 'repeat'); }
        const chartData = ${JSON.stringify(currentData)};
        if(chartData.datasets.length > 0 && chartData.datasets[0].label === 'Critical Zone') {
            chartData.datasets[0].backgroundColor = createPattern('rgba(220, 38, 38, 0.4)');
            chartData.datasets[0].fill = 'end';
        }
        new Chart(document.getElementById('popChart'),{type:'line',data:chartData,options:{...${JSON.stringify(currentOptions)},maintainAspectRatio:false, animation:false}});<\/script></body></html>`); w.document.close();
    }

    const slider = document.getElementById('hlSlider');
    slider.oninput = function() { highlightRow(parseInt(this.value)); };
    function highlightRow(idx) {
        if(idx < 1 || idx > totalRows) return;
        slider.value = idx;
        const prev = document.querySelector('.highlighted-row');
        if(prev) prev.classList.remove('highlighted-row');
        const row = document.getElementById(`row-${idx}`);
        if(row) {
            row.classList.add('highlighted-row'); row.scrollIntoView({block:'center',behavior:'smooth'});
            document.getElementById('hlReadout').innerText = row.cells[0].innerText + " m"; document.getElementById('hlToolbar').classList.add('hl-active');
        }
    }
    function moveHighlight(dir) { let current = parseInt(slider.value)||0; highlightRow(current+dir); }
    function clearHighlight() {
        const prev = document.querySelector('.highlighted-row');
        if(prev) prev.classList.remove('highlighted-row');
        slider.value = 0; document.getElementById('hlReadout').innerText = "--"; document.getElementById('hlToolbar').classList.remove('hl-active');
    }
    
    function solveLive() { 
        const chartMode = Array.from(document.querySelectorAll('.p-check:checked')).map(c => c.value)[0];
        if(chartMode !== 'layback') { alert("‚ö†Ô∏è Please select 'Layback' in Section 3 to use the Solver."); return; }

        // 1. Get Environmental Data
        const wW = parseFloat(document.getElementById('wW').value);
        const wA = parseFloat(document.getElementById('wA').value);
        const sH = parseFloat(document.getElementById('sH').value);
        const sR = parseFloat(document.getElementById('sR').value);
        const mu = parseFloat(document.getElementById('fric').value) || 0;
        
        // 2. Get User Observations
        const inL = parseFloat(document.getElementById('obsL').value);
        const inD = parseFloat(document.getElementById('obsD').value);
        const inA = parseFloat(document.getElementById('obsA').value);

        // 3. Validation
        let validInputs = 0;
        if(!isNaN(inL) && inL > 0) validInputs++; 
        if(!isNaN(inD) && inD > 0) validInputs++; 
        if(!isNaN(inA) && inA > 0) validInputs++;
        if(validInputs !== 2) { alert("‚ö†Ô∏è Please enter exactly TWO positive values in Section 4."); return; }

        // 4. Binary Search Setup
        let solvedH = 0;
        let finalRes = null;
        let iterations = 0;
        let low = 1, high = 1000000; // 1000 Tonne limit

        // SCENARIO A: Known Depth & Layback -> Find Tension
        if(!isNaN(inD) && !isNaN(inL)) {
            while(iterations < 100) {
                let mid = (low + high) / 2;
                let r = solveTwoSegmentSystem(mid, inD, wW, wA, sH, sR, mu);
                if(r.layback < inL) low = mid; // Needs more tension to stretch further
                else high = mid;
                solvedH = mid;
                if(Math.abs(r.layback - inL) < 0.05) break; 
                iterations++;
            }
            finalRes = solveTwoSegmentSystem(solvedH, inD, wW, wA, sH, sR, mu);
            document.getElementById('resMissing').innerText = finalRes.angle.toFixed(1) + " ¬∞";
            document.querySelector("#solverPanel .res-item:nth-child(3) .res-label").innerText = "CALCULATED ANGLE";
        }
        
        // SCENARIO B: Known Depth & Angle -> Find Tension
        else if(!isNaN(inD) && !isNaN(inA)) {
            while(iterations < 100) {
                let mid = (low + high) / 2;
                let r = solveTwoSegmentSystem(mid, inD, wW, wA, sH, sR, mu);
                // Angle is from vertical (0=down, 90=flat).
                if(r.angle < inA) low = mid; // Angle too steep, need more tension to flatten
                else high = mid;
                solvedH = mid;
                if(Math.abs(r.angle - inA) < 0.05) break; 
                iterations++;
            }
            finalRes = solveTwoSegmentSystem(solvedH, inD, wW, wA, sH, sR, mu);
            document.getElementById('resMissing').innerText = finalRes.layback.toFixed(2) + " m";
            document.querySelector("#solverPanel .res-item:nth-child(3) .res-label").innerText = "CALCULATED LAYBACK";
        }

        // SCENARIO C: Unsafe
        else {
            alert("‚ö†Ô∏è Please provide DEPTH as one of your two values.");
            return;
        }

        // 5. Output Results
        if(finalRes) {
            solverTarget = { h: solvedH, y: inD, x: finalRes.layback };

            // MAIN PANEL (The green box)
            document.getElementById('resLen').innerText = finalRes.length.toFixed(2) + " m";
            
            // FIX: Display solvedH (Bottom Tension) here, NOT finalRes.tension (Winch Tension)
            document.getElementById('resBot').innerText = solvedH.toFixed(0) + " kg"; 
            
            // SIDEBAR RESULTS
            // We display Bottom Tension as primary, but I've added Winch Tension as extra info just in case
            document.getElementById('sbResBot').innerText = solvedH.toFixed(0) + " kg";
            document.getElementById('sbResLen').innerText = finalRes.length.toFixed(2) + " m";
            
            // Re-purposing the "Result" box in sidebar to show the Calculated Missing Value
            document.getElementById('sbResExtraVal').innerText = document.getElementById('resMissing').innerText;
            document.getElementById('sbResExtraLabel').innerText = document.querySelector("#solverPanel .res-item:nth-child(3) .res-label").innerText;
            
            document.getElementById('sidebarSolverResult').style.display = 'block';
            solverActive = true; 
            runMain(); 
            document.getElementById('solverPanel').style.display='block'; 
            if(window.innerWidth <= 1024) switchTab('tab-chart');
          ;
 
            
            // Trigger Chart Refresh
            runMain(); 
            
            document.getElementById('solverPanel').style.display='block'; 
            if(window.innerWidth <= 1024) switchTab('tab-chart');
        }
    }
    
    window.onload = () => { initDropdown(); updateTensionTags(); runMain(); };
</script>
</body>
</html>
