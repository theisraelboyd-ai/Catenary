<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catenary Suite - Precision Desktop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- GLOBAL RESET --- */
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --brand: #004080; --bg: #f0f2f5; --panel: #ffffff;
            --border: #d1d5db; --accent: #15803d; --danger: #b91c1c; 
            --sidebar-w: 360px;
            --text-main: #1f2937; --text-muted: #6b7280;
            --hl-color: #fff9c4;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* --- DESKTOP LAYOUT --- */
        .app-view { display: flex; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-w); background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 20; }
        .table-view { flex: 1.6; display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); background: #fff; }
        .chart-view { flex: 1; display: flex; flex-direction: column; padding: 20px; background: #f8f9fa; }

        /* --- MOBILE NAV (Hidden on Desktop) --- */
        .mobile-nav { display: none; }

        @media screen and (max-width: 1024px) {
            body { flex-direction: column; }
            .sidebar, .table-view, .chart-view { display: none; width: 100%; height: 100dvh; border: none; padding: 15px; overflow-y: auto; padding-bottom: 140px !important; -webkit-overflow-scrolling: touch; }
            .active-mobile-view { display: flex !important; animation: fadeIn 0.2s ease-out; }
            .mobile-nav { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 60px; background: #fff; border-top: 1px solid #ddd; position: fixed; bottom: 0; width: 100%; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
            .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-top: 3px solid transparent; transition: all 0.2s; user-select: none; }
            .nav-item.active { color: var(--brand); border-top-color: var(--brand); background: #f8faff; }
            .nav-icon { font-size: 18px; margin-bottom: 3px; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- UI ELEMENTS --- */
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        .panel-title { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--brand); letter-spacing: 0.5px; }
        .section-title { margin: 20px 0 8px 0; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .instruction { font-size: 12px; color: #4b5563; margin-bottom: 12px; line-height: 1.4; }
        .panel-instruction { font-size: 12px; color: #4b5563; margin-bottom: 12px; margin-top:-5px; }

        /* Standard Inputs */
        .input-row { display: grid; grid-template-columns: 1fr 125px; gap: 10px; margin-bottom: 8px; align-items: center; font-size: 13px; font-weight: 500; }
        
        input[type="number"], select { 
            padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; 
            font-size: 14px; text-align: center; color: var(--text-main); 
            transition: border 0.2s; font-family: inherit; width: 100%; background: #fff;
        }
        input[type="number"] { -webkit-appearance: none; -moz-appearance: textfield; }
        select { -webkit-appearance: none; appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 40px; }
        input:focus, select:focus { border-color: var(--brand); outline: 2px solid rgba(0,64,128,0.1); outline-offset: -1px; }
        
        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 8px; font-size: 13px; transition: all 0.2s; }
        .btn-primary { background: var(--brand); color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: #003366; transform: translateY(-1px); }
        .btn-lite { background: #fff; border: 1px solid #d1d5db; color: var(--text-main); padding: 8px; }
        .btn-md { padding: 5px 12px; font-size: 11px; width: auto; background: #fff; border: 1px solid var(--brand); color: var(--brand); border-radius: 4px; }
        .btn-info { font-size: 11px; background: none; border: none; color: var(--text-muted); text-decoration: underline; cursor: pointer; padding: 0; margin-bottom: 10px; text-align: left; }

        .solver-actions { display: grid; grid-template-columns: 3fr 1fr; gap: 8px; margin-top: 8px; }
        .btn-solver { background: var(--accent); color: white; margin-top: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-clear { background: #fff1f0; color: var(--danger); border: 1px solid #ffa39e; margin-top: 0; font-size: 11px; border-radius: 4px; }

        /* Sidebar Result */
        .sidebar-result { margin-top: 10px; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; border-left: 4px solid var(--accent); display: none; animation: fadeIn 0.3s ease-out; }
        .sb-res-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .sb-res-label { font-size: 10px; font-weight: 700; color: #166534; text-transform: uppercase; }
        .sb-res-val { font-size: 13px; font-weight: 700; color: #14532d; }

        /* Checkboxes */
        .param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .big-check { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; transition: 0.2s; background: #fff; }
        .big-check input { transform: scale(1.1); cursor: pointer; }
        .big-check span { font-size: 12px; font-weight: 600; }
        .tension-tag { display: inline-flex; align-items: center; background: #eef2ff; color: var(--brand); padding: 3px 8px; border-radius: 4px; margin: 3px; font-size: 11px; font-weight: 700; border: 1px solid #c7d2fe; }
        .tension-tag span { margin-left: 6px; cursor: pointer; color: #ef4444; font-weight: 900; }

        /* --- TABLE --- */
        .table-wrapper { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; text-align: center; }
        th { position: sticky; top: 0; z-index: 10; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(8px); padding: 10px 6px; font-weight: 700; color: var(--text-muted); border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 11; background: #fff; border-right: 2px solid var(--border); }
        th:first-child { z-index: 12; }
        td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; font-variant-numeric: tabular-nums; }
        tr:hover td { background-color: #f8fafc; }
        tr.highlighted-row td { background-color: var(--hl-color) !important; border-top: 1px solid #fce788; border-bottom: 1px solid #fce788; font-weight: 700; color: #333; }
        .cascade-row { animation: waterfall 0.3s ease-out forwards; opacity: 0; }
        @keyframes waterfall { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CHART CONTROLS (TINY BOXES) --- */
        .chart-controls { 
            padding: 12px; background: #fff; border: 1px solid var(--border); 
            border-radius: 4px; margin-top: 15px; 
        }
        
        .range-group { 
            display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; 
            border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;
        }
        .range-group:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }

        .range-header {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }
        .range-label { font-size: 10px; font-weight: 800; color: #4b5563; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Spring push to the right */
        .range-values { display: flex; align-items: center; gap: 5px; margin-left: auto; }
        
        /* TINY INPUTS */
        .micro-input { 
            width: 45px !important; /* Force width */
            flex: 0 0 45px; /* Prevent flex grow */
            padding: 2px 0 !important; /* Minimal padding */
            text-align: center; font-size: 11px; height: 24px;
            border: 1px solid #d1d5db; border-radius: 3px; font-weight: 600; color: var(--text-main); 
        }
        
        .slider-row { display: flex; width: 100%; margin-top: 6px; }
        .hybrid-slider { flex: 1; accent-color: var(--brand); cursor: pointer; height: 4px; width: 100%; }

        /* --- SOLVER PANEL --- */
        .solver-panel { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; padding: 12px; margin-bottom: 15px; display: none; border-left: 4px solid var(--accent); }
        .solver-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .res-item { display: flex; flex-direction: column; }
        .res-label { font-size: 9px; color: #166534; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; } 
        .res-val { font-size: 16px; font-weight: 800; color: #14532d; font-family: 'Segoe UI', sans-serif; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 30px; border-radius: 6px; width: 700px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        .math-row { font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; margin: 8px 0; border-radius: 4px; font-size: 13px; border-left: 4px solid var(--brand); color: #334155; }
        .help-section { margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; padding-bottom: 16px; }
        .help-title { margin:0 0 8px 0; color:var(--text-main); font-size:16px; font-weight:700; }
        .help-text { font-size:13px; line-height:1.6; color:#475569; margin-bottom:8px; }

        /* --- HIGHLIGHTER --- */
        .hl-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; background: #fff; border: 1px solid var(--border); border-bottom: none; padding: 8px 12px; border-radius: 4px 4px 0 0; justify-content: center; }
        .hl-active { background: #fffbeb; border-color: #fcd34d; }
        .hl-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .hl-slider { flex: 1; accent-color: #f59e0b; cursor: pointer; min-width: 100px; }
        .hl-btn { padding: 3px 8px; font-size: 10px; cursor: pointer; background: white; border: 1px solid #d1d5db; border-radius: 3px; font-weight: 600; color: var(--text-main); }
    </style>
</head>
<body>

<div id="mathModal" class="modal-overlay" onclick="toggleMath(false)">
    <div class="modal-card" onclick="event.stopPropagation()">
        
        <div style="border-bottom:2px solid #e2e8f0; margin-bottom:20px; padding-bottom:15px;">
            <h3 style="margin:0; color:var(--brand); font-size:24px; font-weight:800;">Catenary Physics Engine</h3>
            <p style="margin:5px 0 0 0; color:#64748b; font-size:14px; font-weight:500;">A Comprehensive Guide to Subsea Cable Mechanics</p>
        </div>
        
        <div class="help-section">
            <h4 class="help-title">1. What is a "Catenary"?</h4>
            <p class="help-text">
                Imagine holding a heavy chain between your hands. The shape it naturally forms under its own weight is called a <strong>Catenary</strong>. While it looks like a simple curve (a parabola), it is actually a much more complex shape governed by "Hyperbolic" geometry.
            </p>
            <p class="help-text">
                The key to understanding this curve is the <strong>Catenary Parameter (<i>a</i>)</strong>. Think of <i>a</i> as the "Stiffness" of the curve:
            </p>
            <ul style="font-size:13px; color:#475569; padding-left:20px; line-height:1.6; margin-bottom:15px;">
                <li><strong>High Tension</strong> = Large <i>a</i> = The curve is flat and tight.</li>
                <li><strong>Low Tension</strong> = Small <i>a</i> = The curve is deep and sagging.</li>
            </ul>
            
            <div style="background:#f8fafc; padding:15px; border-left:4px solid var(--brand); margin:10px 0; border-radius:4px;">
                <strong style="color:var(--text-main); display:block; margin-bottom:5px; font-size:11px; text-transform:uppercase; letter-spacing:0.5px;">The Governing Formula</strong>
                <div class="math-row" style="font-size:14px;">y = a &middot; [ cosh( x / a ) - 1 ]</div>
                <p style="font-size:11px; color:#64748b; margin:5px 0 0 0; line-height:1.4;">
                    <em>Where <strong>y</strong> is depth, <strong>x</strong> is horizontal distance, and <strong>cosh</strong> is the "Hyperbolic Cosine" function.</em>
                </p>
            </div>
        </div>

        <div class="help-section">
            <h4 class="help-title">2. Forces & The "Triangle of Tension"</h4>
            <p class="help-text">
                The tension in the cable is not the same everywhere. It is lowest at the bottom (where it only pulls horizontally) and highest at the top (where it must support the entire weight of the line).
            </p>
            <p class="help-text">
                We calculate the Top Tension by treating it as the long side (hypotenuse) of a right-angled triangle:
            </p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div style="background:#f0fdf4; padding:12px; border-radius:4px; border:1px solid #bbf7d0;">
                    <strong style="color:#15803d; font-size:11px;">SIDE A: HORIZONTAL</strong>
                    <div style="font-size:12px; color:#14532d; margin-top:4px;">Constant Pull (H)</div>
                </div>
                <div style="background:#f0fdf4; padding:12px; border-radius:4px; border:1px solid #bbf7d0;">
                    <strong style="color:#15803d; font-size:11px;">SIDE B: VERTICAL</strong>
                    <div style="font-size:12px; color:#14532d; margin-top:4px;">Total Weight (V)</div>
                </div>
            </div>

            <div class="math-row" style="margin-top:10px; background:#e0f2fe; border-color:#0284c7; color:#0369a1;">
                Top Tension = &radic;( H&sup2; + V&sup2; )
            </div>
        </div>

        <div class="help-section">
            <h4 class="help-title">3. The Solver (Reverse Engineering)</h4>
            <p class="help-text">
                <strong>The Problem:</strong> In the field, you know <em>where</em> the ROV is (e.g., "Depth 50m, Layback 120m"), but the math formulas only work if you know the Tension. You cannot easily rearrange the Catenary equation to solve for Tension directly.
            </p>
            <p class="help-text">
                <strong>The Solution:</strong> This tool uses a numerical method called <strong>Newton-Raphson Iteration</strong>. It plays a rapid game of "Hot or Cold" with the physics engine:
            </p>
            <ol style="font-size:13px; color:#475569; padding-left:25px; line-height:1.6; margin-top:8px;">
                <li style="margin-bottom:6px;">The computer <strong>guesses</strong> a tension (e.g., 500kg).</li>
                <li style="margin-bottom:6px;">It calculates where the cable <em>would</em> be with that tension.</li>
                <li style="margin-bottom:6px;">It measures the <strong>error</strong> (e.g., "We are 5.2m too short").</li>
                <li style="margin-bottom:6px;">It calculates the slope of the error curve to make a highly precise second guess.</li>
                <li>It repeats this process approx. 50 times in a split second until the error is <strong>0.00m</strong>.</li>
            </ol>
        </div>

        <div style="background:#f9fafb; padding:15px; border-radius:6px; border:1px solid #e5e7eb; margin-top:10px;">
            <strong style="font-size:12px; color:#374151;">HOW THIS TOOL HELPS:</strong>
            <p style="font-size:12px; color:#6b7280; margin:5px 0 0 0; line-height:1.5;">
                By using the "As-Laid" solver, you can validate your deck tension. If the solver says you need <strong>600kg</strong> to reach the ROV's position, but your winch reads <strong>450kg</strong>, you immediately know that external forces (like current drag) are acting on your line.
            </p>
        </div>
        
        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-primary" style="width:auto; padding:10px 30px;" onclick="toggleMath(false)">Close Reference</button>
        </div>
    </div>
</div>

<div class="app-view">
    <div id="tab-config" class="sidebar active-mobile-view">
        <h3 style="margin-bottom:5px; color:var(--brand);">Catenary Suite</h3>
        <button class="btn-info" onclick="toggleMath(true)">‚ìò Physics & Solver Guide</button>
        
        <div class="section-title">1. Environmental Inputs</div>
        <p class="instruction">Configure cable & geometry.</p>
        <div class="input-row"><span>Wt Water (kg/m)</span><input type="number" id="wW" value="50" inputmode="decimal"></div>
        <div class="input-row"><span>Wt Air (kg/m)</span><input type="number" id="wA" value="60" inputmode="decimal"></div>
        <div class="input-row"><span>Sheave Height (m)</span><input type="number" id="sH" value="1" inputmode="decimal"></div>
        <div class="input-row"><span>Sheave Radius (m)</span><input type="number" id="sR" value="5" inputmode="decimal"></div>
        <div class="input-row"><span>Max Depth (m)</span><input type="number" id="mD" value="100" inputmode="decimal"></div>
        <div class="input-row"><span>Depth Step (m)</span><input type="number" id="dS" value="5" inputmode="decimal"></div>

        <div class="section-title">2. Tension Comparison</div>
        <div class="input-row">
            <span>Select Tension</span>
            <select id="tSelect"></select>
        </div>
        <button class="btn btn-lite" onclick="addTension()">+ Add to Comparison</button>
        <div id="tList" style="margin-top:8px; min-height:20px;"></div>

        <div class="section-title">3. Table & Chart Mode</div>
        <div class="param-grid">
            <label class="big-check"><input type="checkbox" class="p-check" value="layback" checked> <span>Layback</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="length" checked> <span>Length</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="angle"> <span>Angle</span></label>
            <label class="big-check"><input type="checkbox" class="p-check" value="tension"> <span>Tension</span></label>
        </div>

        <button class="btn btn-primary" onclick="runMain(); if(window.innerWidth<=1024) switchTab('tab-chart');">GENERATE DATA</button>

        <div class="section-title" style="margin-top:30px; color:var(--accent); border-color:var(--accent);">4. Raw Data Solver</div>
        <p class="instruction">Enter ANY 2 values to solve.</p>
        <div class="input-row solver-input"><span>Obs Layback</span><input type="number" id="obsL" placeholder="(m)" inputmode="decimal"></div>
        <div class="input-row solver-input"><span>Obs Depth</span><input type="number" id="obsD" placeholder="(m)" inputmode="decimal"></div>
        <div class="input-row solver-input"><span>Obs Angle</span><input type="number" id="obsA" placeholder="(Deg)" inputmode="decimal"></div>
        <div class="solver-actions">
            <button class="btn btn-solver" onclick="solveLive()">CALC 'AS-LAID'</button>
            <button class="btn btn-clear" onclick="clearSolver()">CLEAR</button>
        </div>
        
        <div id="sidebarSolverResult" class="sidebar-result">
            <div class="sb-res-row"><span class="sb-res-label">Target Tension</span><span class="sb-res-val" id="sbResBot">--</span></div>
            <div class="sb-res-row"><span class="sb-res-label">Total Length</span><span class="sb-res-val" id="sbResLen">--</span></div>
            <div class="sb-res-row" style="border-top:1px solid #bbf7d0; padding-top:4px; margin-top:4px;"><span class="sb-res-label" id="sbResExtraLabel">Result</span><span class="sb-res-val" id="sbResExtraVal">--</span></div>
        </div>
    </div>

    <div id="tab-table" class="table-view">
        <div class="panel-header">
            <span class="panel-title">Calculated Results</span>
            <button class="btn btn-md" onclick="printTableWindow()">üñ® Print</button>
        </div>
        <p class="panel-instruction">Comprehensive tabular breakdown.</p>
        <div id="hlToolbar" class="hl-toolbar">
            <span class="hl-label">Row Highlighter:</span>
            <input type="range" id="hlSlider" class="hl-slider" min="0" max="0" value="0" disabled>
            <span id="hlReadout" style="font-size:12px; font-weight:bold; min-width:30px; text-align:right;">--</span>
            <button class="hl-btn" onclick="moveHighlight(-1)">‚ñ≤</button>
            <button class="hl-btn" onclick="moveHighlight(1)">‚ñº</button>
            <button class="hl-btn" onclick="clearHighlight()">Clear</button>
        </div>
        <div class="table-wrapper">
            <table id="mainTable"><thead id="tableHdr"></thead><tbody id="tableBdy"></tbody></table>
        </div>
    </div>

    <div id="tab-chart" class="chart-view">
        <div id="solverPanel" class="solver-panel">
            <div style="font-size:11px; font-weight:bold; color:#166534; border-bottom:1px solid #86efac; margin-bottom:12px;">SOLVER RESULTS (AS-LAID)</div>
            <div class="solver-grid">
                <div class="res-item"><span class="res-label">Total Length</span><span class="res-val highlight" id="resLen">--</span></div>
                <div class="res-item"><span class="res-label">Bottom Tension</span><span class="res-val" id="resBot">--</span></div>
                <div class="res-item"><span class="res-label">Dep. Angle (Vert)</span><span class="res-val" id="resMissing">--</span></div>
            </div>
        </div>

        <div class="panel-header">
            <span class="panel-title">Dynamic Profile</span>
            <button class="btn btn-md" onclick="popChartWindow()">‚§¢ Pop-out</button>
        </div>
        
        <div style="flex:1; background:white; border:1px solid var(--border); padding:5px; position:relative; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.03); min-height: 250px;">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="chart-controls">
            <div class="range-group">
                <div class="range-header">
                    <span class="range-label">DEPTH</span>
                    <div class="range-values">
                        <input type="number" id="minXBox" class="micro-input" value="0" onchange="sync('minX', 'Box')" inputmode="decimal">
                        <span style="color:#aaa; font-size:10px;">‚Äî</span>
                        <input type="number" id="maxXBox" class="micro-input" value="100" onchange="sync('maxX', 'Box')" inputmode="decimal">
                    </div>
                </div>
                <div class="slider-row">
                    <input type="range" id="minXSlider" class="hybrid-slider" min="0" max="100" value="0" oninput="syncVisual('minX')" onchange="syncFinal('minX')">
                    <input type="range" id="maxXSlider" class="hybrid-slider" min="0" max="100" value="100" oninput="syncVisual('maxX')" onchange="syncFinal('maxX')">
                </div>
            </div>

            <div class="range-group">
                <div class="range-header">
                    <span class="range-label" id="yLabel">LAYBACK (M)</span>
                    <div class="range-values">
                        <input type="number" id="minYBox" class="micro-input" value="0" onchange="sync('minY', 'Box')" inputmode="decimal">
                        <span style="color:#aaa; font-size:10px;">‚Äî</span>
                        <input type="number" id="maxYBox" class="micro-input" value="100" onchange="sync('maxY', 'Box')" inputmode="decimal">
                    </div>
                </div>
                <div class="slider-row">
                    <input type="range" id="minYSlider" class="hybrid-slider" min="0" max="100" value="0" oninput="syncVisual('minY')" onchange="syncFinal('minY')">
                    <input type="range" id="maxYSlider" class="hybrid-slider" min="0" max="100" value="100" oninput="syncVisual('maxY')" onchange="syncFinal('maxY')">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mobile-nav">
    <div class="nav-item active" onclick="switchTab('tab-config', this)"><span class="nav-icon">‚öôÔ∏è</span><span>Config</span></div>
    <div class="nav-item" onclick="switchTab('tab-table', this)"><span class="nav-icon">üìä</span><span>Data</span></div>
    <div class="nav-item" onclick="switchTab('tab-chart', this)"><span class="nav-icon">üìà</span><span>Graph</span></div>
</div>

<script>
    const ACOSH = Math.acosh || function(x){ return Math.log(x + Math.sqrt((x-1)*(x+1))); };
    const SINH  = Math.sinh  || function(x){ const e=Math.exp(x), ei=1/e; return (e-ei)/2; };

    function solveAByLayback(x, depth, tol=1e-5, maxIt=50) {
        if(x <= 0 || depth <= 0) return 100;
        let a = (x*x) / (2*depth); if(a < 1) a = 10;
        for(let i=0; i<maxIt; i++) {
            const term = x/a;
            const f = a * (Math.cosh(term) - 1) - depth;
            const df = (Math.cosh(term) - 1) - term*Math.sinh(term);
            if(Math.abs(f) < tol) return a;
            a = a - f/df; if(a <= 0.1) a = 0.1; 
        }
        return a;
    }

    function calcAirLength(sH, sR) {
        if(sR < 0) sR = 0; if(sH < 0) sH = 0;
        if (sH <= sR) return sH + (Math.PI * sR / 4); 
        return (sH - sR) + (Math.PI * sR / 2);
    }

    let activeTensions = [400];
    let solverActive = false;
    let solverTarget = { x:0, y:0 }; 
    let chart;
    let totalRows = 0;
    const colors = ['#004080', '#c0392b', '#8e44ad', '#f39c12', '#2c3e50'];
    const MAX_RENDER_LIMIT = 5000;
    let deploymentTimer = null;

    function initDropdown() {
        const select = document.getElementById('tSelect');
        select.innerHTML = ""; 
        for(let i=250; i<=2000; i+=50){
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = i + " kg";
            if(i===400) opt.selected = true;
            select.appendChild(opt);
        }
    }

    function switchTab(tabId, el) {
        if(window.innerWidth > 1024) return; 
        document.querySelectorAll('.sidebar, .table-view, .chart-view').forEach(div => {
            div.classList.remove('active-mobile-view');
        });
        document.getElementById(tabId).classList.add('active-mobile-view');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
        } else {
            const index = (tabId === 'tab-config') ? 0 : (tabId === 'tab-table') ? 1 : 2;
            const items = document.querySelectorAll('.nav-item');
            items.forEach(item => item.classList.remove('active'));
            items[index].classList.add('active');
        }
        window.scrollTo(0,0);
        if(tabId === 'tab-chart' && chart) {
            setTimeout(() => { chart.resize(); }, 100);
        }
    }

    function toggleMath(show) { document.getElementById('mathModal').style.display = show ? 'flex' : 'none'; }
    function addTension() { let val = parseInt(document.getElementById('tSelect').value); if (!activeTensions.includes(val)) { activeTensions.push(val); updateTensionTags(); } }
    function updateTensionTags() { document.getElementById('tList').innerHTML = activeTensions.map(t => `<span class="tension-tag">${t}kg <span onclick="removeT(${t})">&times;</span></span>`).join(''); }
    function removeT(t) { activeTensions = activeTensions.filter(x => x !== t); updateTensionTags(); }

    function runMain() {
        const wW = parseFloat(document.getElementById('wW').value);
        const wA = parseFloat(document.getElementById('wA').value);
        const sH = parseFloat(document.getElementById('sH').value);
        const sR = parseFloat(document.getElementById('sR').value);
        const mD = parseFloat(document.getElementById('mD').value);
        const dS = parseFloat(document.getElementById('dS').value);
        const selectedParams = Array.from(document.querySelectorAll('.p-check:checked')).map(c => c.value);
        
        let chartMode = 'layback'; 
        if(selectedParams.length > 0) chartMode = selectedParams[0];

        let headHtml = `<tr><th style="background:#fff;">Depth (m)</th>`;
        activeTensions.forEach((t, i) => { 
            const color = colors[i % colors.length];
            const bgTint = color + '15'; 
            selectedParams.forEach(p => {
                let suffix = "";
                if(p==='layback') suffix="Layback (m)";
                if(p==='length') suffix="Length (m)";
                if(p==='angle') suffix="Angle (¬∞)";
                if(p==='tension') suffix="Top Tens (kg)";
                headHtml += `<th style="border-top: 4px solid ${color}; background: linear-gradient(0deg, ${bgTint}, ${bgTint}), #fff; color:${color};">${t}kg ${suffix}</th>`;
            }); 
        });
        document.getElementById('tableHdr').innerHTML = headHtml;

        const airLen = calcAirLength(sH, sR);
        const airWt = airLen * wA; 

        let bdyHtml = "";
        const fullDatasets = [];
        let rowCount = 0;

        for (let d = 0; d <= mD; d += dS) {
            rowCount++;
            let row = `<td>${d}</td>`;
            activeTensions.forEach((t, i) => {
                const a = t / wW;
                let x = 0, s = 0, angle = 0, tension = 0, valid = true;
                const color = colors[i % colors.length];

                if (a <= 0.01 || (d/a) > 200) { valid = false; } 
                else {
                    x = a * ACOSH(d / a + 1);
                    const sWater = a * SINH(x / a);
                    if (x > MAX_RENDER_LIMIT) x = MAX_RENDER_LIMIT;
                    
                    s = sWater + airLen; 
                    const V_water = sWater * wW;
                    const V_total = V_water + airWt; 
                    
                    tension = Math.sqrt(t*t + V_total*V_total); 
                    const angleRad = Math.atan(V_total / t);
                    angle = 90 - ((angleRad * 180) / Math.PI); 
                }

                if(valid) {
                    selectedParams.forEach(p => {
                        let val = "";
                        if(p === 'layback') val = x.toFixed(2);
                        if(p === 'length') val = s.toFixed(2);
                        if(p === 'angle') val = angle.toFixed(1) + "¬∞";
                        if(p === 'tension') val = tension.toFixed(0);
                        row += `<td style="color:${color}; font-weight:600;">${val}</td>`;
                    });
                    
                    let plotVal = x;
                    if(chartMode === 'length') plotVal = s;
                    if(chartMode === 'angle') plotVal = angle;
                    if(chartMode === 'tension') plotVal = tension;

                    if(!fullDatasets[i]) fullDatasets[i] = { 
                        label: t+'kg', data: [], 
                        borderColor: colors[i % colors.length], borderWidth: 2, pointRadius: 0, pointHitRadius: 15 
                    };
                    fullDatasets[i].data.push({x: d, y: plotVal});
                } else {
                    selectedParams.forEach(p => row += `<td style="color:#ccc;">---</td>`);
                    if(!fullDatasets[i]) fullDatasets[i] = { label: t+'kg', data: [], borderColor: colors[i % colors.length] };
                }
            });
            bdyHtml += `<tr id="row-${rowCount}" class="cascade-row" style="animation-delay: ${rowCount * 0.01}s">${row}</tr>`;
        }
        
        document.getElementById('tableBdy').innerHTML = bdyHtml;
        totalRows = rowCount;
        const slider = document.getElementById('hlSlider');
        slider.max = totalRows; slider.disabled = false;
        clearHighlight();

        if(solverActive && chartMode === 'layback') {
            const solvedA = solverTarget.a;
            const targetD = solverTarget.y; 
            const solverPoints = [];
            for(let k=0; k<=50; k++) {
                const d_i = (targetD * k) / 50;
                const x_i = solvedA * ACOSH(d_i / solvedA + 1);
                solverPoints.push({ x: d_i, y: x_i });
            }
            fullDatasets.push({ label: 'As-Laid Target', data: solverPoints, borderColor: '#28a745', borderDash: [5, 5], borderWidth: 2, pointRadius: 0 });
        }
        
        setTimeout(() => { animateDeployment(fullDatasets, chartMode); }, 10);
    }

    function animateDeployment(fullDatasets, mode) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(deploymentTimer) clearInterval(deploymentTimer);
        if (chart) chart.destroy();

        const renderDatasets = fullDatasets.map(ds => ({ ...ds, data: [] }));

        let maxX = 0; let maxY = 0;
        fullDatasets.forEach(ds => { ds.data.forEach(p => { if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y; }); });
        if(!maxX || maxX < 10) maxX = 100; if(!maxY || maxY < 10) maxY = 100;

        initFilterGroup('minX', 0, maxX); initFilterGroup('maxX', maxX, maxX);
        initFilterGroup('minY', 0, maxY); initFilterGroup('maxY', maxY, maxY);

        let yTitle = 'Horizontal Layback (m)';
        if(mode === 'length') yTitle = 'Arc Length (m)';
        if(mode === 'angle') yTitle = 'Departure Angle (Vert ¬∞)';
        if(mode === 'tension') yTitle = 'Top Tension (kg)';
        
        document.getElementById('yLabel').innerText = mode.toUpperCase() + " (M)";
        if(mode === 'angle') document.getElementById('yLabel').innerText = "ANGLE (DEG)";
        if(mode === 'tension') document.getElementById('yLabel').innerText = "TENSION (KG)";

        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: renderDatasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: false, 
                layout: { padding: { left: 10, right: 20, top: 20, bottom: 10 } },
                interaction: { mode: 'nearest', intersect: false, axis: 'xy' },
                plugins: {
                    tooltip: { enabled: true, backgroundColor: 'rgba(0,0,0,0.85)', titleFont: { size: 12 }, bodyFont: { size: 12 }, padding: 10, displayColors: true,
                    callbacks: { label: function(c) { return c.dataset.label + ': ' + c.parsed.y.toFixed(2); } } }
                },
                scales: { 
                    x: { type: 'linear', title: { display: true, text: 'Depth (m)' }, min: 0, max: maxX },
                    y: { title: { display: true, text: yTitle }, min: 0, max: maxY } 
                }
            }
        });

        let frameIndex = 0;
        deploymentTimer = setInterval(() => {
            let changed = false;
            fullDatasets.forEach((sourceDs, i) => {
                if(frameIndex < sourceDs.data.length) {
                    chart.data.datasets[i].data.push(sourceDs.data[frameIndex]);
                    changed = true;
                }
            });
            if(changed) { chart.update('none'); frameIndex++; } else { clearInterval(deploymentTimer); }
        }, 15);
    }

    function initFilterGroup(prefix, val, maxLimit) {
        const slider = document.getElementById(prefix + 'Slider');
        const box = document.getElementById(prefix + 'Box');
        slider.max = Math.ceil(maxLimit); slider.value = Math.ceil(val); box.value = Math.ceil(val);
    }
    function syncVisual(prefix) { document.getElementById(prefix + 'Box').value = document.getElementById(prefix + 'Slider').value; }
    function syncFinal(prefix) { applyFilters(); }
    function sync(prefix, source) { if(source==='Box') { document.getElementById(prefix+'Slider').value = document.getElementById(prefix+'Box').value; applyFilters(); } }
    
    function applyFilters() {
        if(!chart) return;
        chart.options.scales.x.min = parseFloat(document.getElementById('minXBox').value);
        chart.options.scales.x.max = parseFloat(document.getElementById('maxXBox').value);
        chart.options.scales.y.min = parseFloat(document.getElementById('minYBox').value);
        chart.options.scales.y.max = parseFloat(document.getElementById('maxYBox').value);
        chart.update('none');
    }

    function printTableWindow() {
        const meta = document.querySelector('.sidebar .input-row').parentNode.innerHTML; 
        const wW = document.getElementById('wW').value; const wA = document.getElementById('wA').value; const sH = document.getElementById('sH').value;
        const tableHtml = document.getElementById('mainTable').outerHTML;
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html><html><head><title>Print Table</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>:root { --brand: #004080; --text-main: #2c3e50; --text-muted: #6c757d; --border: #e0e6ed; } body { font-family: 'Inter', sans-serif; padding: 40px; color: var(--text-main); -webkit-print-color-adjust: exact; print-color-adjust: exact; } .meta-box { background: #f8f9fa; border: 1px solid #e2e8f0; border-left: 6px solid var(--brand); padding: 20px; margin-bottom: 30px; border-radius: 8px; } table { width: 100%; border-collapse: collapse; font-size: 11px; } th { background-color: #f1f5f9 !important; color: #6c757d; font-weight: 700; text-transform: uppercase; padding: 10px 8px; border-bottom: 2px solid #e0e6ed; -webkit-print-color-adjust: exact; } td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; text-align: center; font-variant-numeric: tabular-nums; } td[style*="color"], th[style*="color"] { -webkit-print-color-adjust: exact; } @media print { @page { size: landscape; margin: 15mm; } .btn-print { display: none; } body { padding: 0; } } .btn-print { background: var(--brand); color: white; border: none; padding: 10px 20px; font-weight: 700; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }</style></head><body><button class="btn-print" onclick="window.print()">üñ® Print Report</button><div class="meta-box"><h2 style="margin-top:0; color:var(--brand); font-size:18px;">Catenary Analysis Report</h2><div style="margin-top:10px; font-size:13px;"><strong>Configuration:</strong> Water Wt: ${wW} kg/m | Air Wt: ${wA} kg/m | Sheave H: ${sH} m</div></div>${tableHtml}</body></html>`); w.document.close();
    }

    function popChartWindow() {
        const currentData = chart.config.data; const currentOptions = chart.config.options; const wW = document.getElementById('wW').value; const wA = document.getElementById('wA').value;
        const w = window.open('', '_blank');
        w.document.write(`<html><head><title>Chart</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script><style>@media print { @page { size: landscape; } body { margin: 0; } .btn-print { display: none; } canvas { max-width: 100%; } } body { font-family: 'Inter', sans-serif; padding: 20px; } .meta { margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-left: 5px solid #004080; border-radius:6px; } .btn-print { background: #004080; color: white; border: none; padding: 10px 20px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }</style></head><body><button class="btn-print" onclick="window.print()">üñ® Print Chart</button><div class="meta"><strong>Catenary Profile</strong> | Wt Water: ${wW} | Wt Air: ${wA}</div><div style="height:80vh"><canvas id="popChart"></canvas></div><script>new Chart(document.getElementById('popChart'),{type:'line',data:${JSON.stringify(currentData)},options:{...${JSON.stringify(currentOptions)},maintainAspectRatio:false}});<\/script></body></html>`); w.document.close();
    }

    const slider = document.getElementById('hlSlider');
    slider.oninput = function() { highlightRow(parseInt(this.value)); };
    function highlightRow(idx) {
        if(idx < 1 || idx > totalRows) return;
        slider.value = idx;
        const prev = document.querySelector('.highlighted-row');
        if(prev) prev.classList.remove('highlighted-row');
        const row = document.getElementById(`row-${idx}`);
        if(row) {
            row.classList.add('highlighted-row'); row.scrollIntoView({block:'center',behavior:'smooth'});
            document.getElementById('hlReadout').innerText = row.cells[0].innerText + " m"; document.getElementById('hlToolbar').classList.add('hl-active');
        }
    }
    function moveHighlight(dir) { let current = parseInt(slider.value)||0; highlightRow(current+dir); }
    function clearHighlight() {
        const prev = document.querySelector('.highlighted-row');
        if(prev) prev.classList.remove('highlighted-row');
        slider.value = 0; document.getElementById('hlReadout').innerText = "--"; document.getElementById('hlToolbar').classList.remove('hl-active');
    }
    
    function solveLive() { 
        const chartMode = Array.from(document.querySelectorAll('.p-check:checked')).map(c => c.value)[0];
        if(chartMode !== 'layback') { alert("‚ö†Ô∏è Please select 'Layback' in Section 3 to use the Solver."); return; }

        const wW = parseFloat(document.getElementById('wW').value);
        const wA = parseFloat(document.getElementById('wA').value);
        const sH = parseFloat(document.getElementById('sH').value);
        const sR = parseFloat(document.getElementById('sR').value);
        const airLen = calcAirLength(sH, sR);
        const airWt = airLen * wA;

        const inL = parseFloat(document.getElementById('obsL').value);
        const inD = parseFloat(document.getElementById('obsD').value);
        const inA = parseFloat(document.getElementById('obsA').value);

        let validInputs = 0;
        if(!isNaN(inL)) validInputs++; if(!isNaN(inD)) validInputs++; if(!isNaN(inA)) validInputs++;
        if(validInputs !== 2) { alert("‚ö†Ô∏è Please enter exactly TWO values in Section 4."); return; }

        let solvedH = 0, totalLen = 0, angleVert = 0, finalA = 0;
        let resMissingLabel = "", resMissingVal = "";

        if(!isNaN(inL) && !isNaN(inD)) {
            finalA = solveAByLayback(inL, inD);
            solvedH = finalA * wW;
            const sWater = finalA * SINH(inL / finalA);
            totalLen = sWater + airLen;
            const V_tot = (sWater * wW) + airWt;
            angleVert = 90 - (Math.atan(V_tot / solvedH) * 180 / Math.PI);
            resMissingLabel = "CALCULATED ANGLE"; resMissingVal = angleVert.toFixed(1) + " ¬∞";
            solverTarget = { a: finalA, y: inD, x: inL };
        }
        else if(!isNaN(inL) && !isNaN(inA)) {
            let low = 1, high = 100000;
            for(let k=0; k<60; k++) {
                let mid = (low+high)/2; let a = mid / wW;
                let sW = a * SINH(inL / a); let V = (sW * wW) + airWt;
                let angCalc = 90 - (Math.atan(V/mid) * 180 / Math.PI);
                if(angCalc < inA) low = mid; else high = mid;
            }
            solvedH = (low+high)/2; finalA = solvedH / wW;
            const calcD = finalA * (Math.cosh(inL/finalA) - 1);
            const sWater = finalA * SINH(inL / finalA);
            totalLen = sWater + airLen;
            resMissingLabel = "CALCULATED DEPTH"; resMissingVal = calcD.toFixed(2) + " m";
            angleVert = inA; solverTarget = { a: finalA, y: calcD, x: inL };
        }
        else if(!isNaN(inD) && !isNaN(inA)) {
            let low = 1, high = 100000;
            for(let k=0; k<60; k++) {
                let mid = (low+high)/2; let a = mid / wW;
                let x = a * ACOSH(inD / a + 1); let sW = a * SINH(x / a); let V = (sW * wW) + airWt;
                let angCalc = 90 - (Math.atan(V/mid) * 180 / Math.PI);
                if(angCalc < inA) low = mid; else high = mid;
            }
            solvedH = (low+high)/2; finalA = solvedH / wW;
            const calcL = finalA * ACOSH(inD/finalA + 1);
            const sWater = finalA * SINH(calcL / finalA);
            totalLen = sWater + airLen;
            resMissingLabel = "CALC. LAYBACK"; resMissingVal = calcL.toFixed(2) + " m";
            angleVert = inA; solverTarget = { a: finalA, y: inD, x: calcL };
        }

        const tStr = solvedH.toFixed(0) + " kg";
        const lStr = totalLen.toFixed(2) + " m";
        
        document.getElementById('resLen').innerText = lStr;
        document.getElementById('resBot').innerText = tStr;
        document.getElementById('resMissing').innerText = resMissingVal;
        
        const labelEl = document.querySelector("#solverPanel .res-item:nth-child(3) .res-label");
        if(labelEl) labelEl.innerText = resMissingLabel;

        document.getElementById('sbResBot').innerText = tStr;
        document.getElementById('sbResLen').innerText = lStr;
        document.getElementById('sbResExtraLabel').innerText = resMissingLabel;
        document.getElementById('sbResExtraVal').innerText = resMissingVal;
        document.getElementById('sidebarSolverResult').style.display = 'block';

        solverActive = true; 
        runMain(); // Trigger chart update
        document.getElementById('solverPanel').style.display='block'; 
        
        if(window.innerWidth <= 1024) switchTab('tab-chart');
    }

    function clearSolver() { 
        solverActive = false; 
        document.getElementById('solverPanel').style.display='none'; 
        document.getElementById('sidebarSolverResult').style.display='none';
        document.getElementById('obsL').value=""; 
        document.getElementById('obsD').value=""; 
        document.getElementById('obsA').value=""; 
        runMain(); 
    }
    
    window.onload = () => { initDropdown(); updateTensionTags(); runMain(); };
</script>
</body>
</html>
